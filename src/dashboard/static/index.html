<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BashBros Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a2e;
      color: #eaeaea;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #2d2d44;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #888;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }

    .status-dot.connected {
      background: #4ade80;
    }

    .status-dot.disconnected {
      background: #ef4444;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #2d2d44;
    }

    .stat-card .label {
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
    }

    .stat-card.warning .value {
      color: #fbbf24;
    }

    .stat-card.error .value {
      color: #ef4444;
    }

    .stat-card.success .value {
      color: #4ade80;
    }

    .section {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #2d2d44;
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #fff;
    }

    .activity-list {
      list-style: none;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #2d2d44;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .activity-icon.info {
      background: #1e40af;
      color: #60a5fa;
    }

    .activity-icon.warning {
      background: #854d0e;
      color: #fbbf24;
    }

    .activity-icon.error {
      background: #7f1d1d;
      color: #ef4444;
    }

    .activity-icon.debug {
      background: #374151;
      color: #9ca3af;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-message {
      font-size: 14px;
      color: #eaeaea;
      word-break: break-word;
    }

    .activity-meta {
      display: flex;
      gap: 16px;
      margin-top: 4px;
      font-size: 12px;
      color: #666;
    }

    .activity-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state p {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>BashBros Dashboard</h1>
    <div class="connection-status">
      <span class="status-dot" id="connectionDot"></span>
      <span id="connectionText">Connecting...</span>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="label">Total Events</div>
      <div class="value" id="totalEvents">0</div>
    </div>
    <div class="stat-card warning">
      <div class="label">Pending Blocks</div>
      <div class="value" id="pendingBlocks">0</div>
    </div>
    <div class="stat-card success">
      <div class="label">Active Connectors</div>
      <div class="value" id="activeConnectors">0</div>
    </div>
    <div class="stat-card error">
      <div class="label">Errors</div>
      <div class="value" id="errors">0</div>
    </div>
  </div>

  <div class="section">
    <h2>Recent Activity</h2>
    <ul class="activity-list" id="activityList">
      <li class="empty-state">
        <p>No recent activity</p>
      </li>
    </ul>
  </div>

  <script>
    // Dashboard state
    let ws = null;
    let reconnectTimeout = null;

    // DOM elements
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const totalEventsEl = document.getElementById('totalEvents');
    const pendingBlocksEl = document.getElementById('pendingBlocks');
    const activeConnectorsEl = document.getElementById('activeConnectors');
    const errorsEl = document.getElementById('errors');
    const activityList = document.getElementById('activityList');

    // Update connection status
    function setConnectionStatus(connected) {
      connectionDot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
      connectionText.textContent = connected ? 'Connected' : 'Disconnected';
    }

    // Update stats display
    function updateStats(stats) {
      totalEventsEl.textContent = stats.totalEvents || 0;
      pendingBlocksEl.textContent = stats.pendingBlocks || 0;
      activeConnectorsEl.textContent = stats.connectorCount || 0;
      errorsEl.textContent = (stats.eventsByLevel && stats.eventsByLevel.error) || 0;
    }

    // Format timestamp
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString();
    }

    // Get icon class based on level
    function getIconClass(level) {
      switch (level) {
        case 'error': return 'error';
        case 'warning': return 'warning';
        case 'debug': return 'debug';
        default: return 'info';
      }
    }

    // Get icon symbol based on level
    function getIconSymbol(level) {
      switch (level) {
        case 'error': return '!';
        case 'warning': return '!';
        case 'debug': return '#';
        default: return 'i';
      }
    }

    // Update activity list
    function updateActivity(events) {
      if (!events || events.length === 0) {
        activityList.innerHTML = '<li class="empty-state"><p>No recent activity</p></li>';
        return;
      }

      activityList.innerHTML = events.slice(0, 20).map(event => `
        <li class="activity-item">
          <div class="activity-icon ${getIconClass(event.level)}">
            ${getIconSymbol(event.level)}
          </div>
          <div class="activity-content">
            <div class="activity-message">${escapeHtml(event.message)}</div>
            <div class="activity-meta">
              <span>${event.source}</span>
              <span>${event.category}</span>
              <span>${formatTime(event.timestamp)}</span>
            </div>
          </div>
        </li>
      `).join('');
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Fetch stats from API
    async function fetchStats() {
      try {
        const response = await fetch('/api/stats');
        if (response.ok) {
          const stats = await response.json();
          updateStats(stats);
        }
      } catch (error) {
        console.error('Failed to fetch stats:', error);
      }
    }

    // Fetch events from API
    async function fetchEvents() {
      try {
        const response = await fetch('/api/events?limit=20');
        if (response.ok) {
          const events = await response.json();
          updateActivity(events);
        }
      } catch (error) {
        console.error('Failed to fetch events:', error);
      }
    }

    // Connect to WebSocket
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;

      try {
        ws = new WebSocket(wsUrl);

        ws.onopen = function() {
          setConnectionStatus(true);
          if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
          }
        };

        ws.onmessage = function(event) {
          try {
            const message = JSON.parse(event.data);
            if (message.type === 'stats') {
              updateStats(message.data);
            } else if (message.type === 'event') {
              fetchEvents();
              fetchStats();
            } else if (message.type === 'block-approved' || message.type === 'block-denied') {
              fetchStats();
            }
          } catch (error) {
            console.error('Failed to parse WebSocket message:', error);
          }
        };

        ws.onclose = function() {
          setConnectionStatus(false);
          ws = null;
          // Attempt to reconnect after 5 seconds
          reconnectTimeout = setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = function() {
          setConnectionStatus(false);
        };
      } catch (error) {
        console.error('Failed to connect WebSocket:', error);
        setConnectionStatus(false);
        reconnectTimeout = setTimeout(connectWebSocket, 5000);
      }
    }

    // Initialize dashboard
    function init() {
      fetchStats();
      fetchEvents();
      connectWebSocket();

      // Auto-refresh every 30 seconds
      setInterval(() => {
        fetchStats();
        fetchEvents();
      }, 30000);
    }

    // Start when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
