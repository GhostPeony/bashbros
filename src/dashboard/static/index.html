<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BashBros Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --white: #FFFFFF;
      --grey-50: #FAFAFA;
      --grey-100: #F5F5F5;
      --grey-200: #EEEEEE;
      --grey-300: #E0E0E0;
      --grey-400: #BDBDBD;
      --grey-500: #9E9E9E;
      --grey-600: #757575;
      --grey-700: #616161;
      --grey-800: #424242;
      --grey-900: #212121;
      --teal: #4DB6AC;
      --teal-light: #80CBC4;
      --teal-dark: #00897B;
      --red: #ef4444;
      --yellow: #fbbf24;
      --orange: #f97316;
      --green: #22c55e;
      --blue: #3b82f6;
      --purple: #8b5cf6;
      --border: 3px solid var(--grey-900);
      --shadow: 6px 6px 0px var(--grey-900);
      --shadow-sm: 4px 4px 0px var(--grey-900);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--grey-100);
      color: var(--grey-900);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--white);
      border-bottom: var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-slash { color: var(--teal); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--grey-600);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--grey-400);
    }
    .status-dot.connected { background: var(--green); }
    .status-dot.disconnected { background: var(--red); }

    /* Navigation */
    .nav-tabs {
      background: var(--white);
      border-bottom: var(--border);
      display: flex;
      gap: 0;
      overflow-x: auto;
    }

    .nav-tab {
      padding: 16px 28px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      background: transparent;
      cursor: pointer;
      border-right: 2px solid var(--grey-300);
      transition: all 0.15s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-tab:hover { background: var(--grey-100); }
    .nav-tab.active {
      background: var(--teal);
      color: var(--white);
    }

    .nav-badge {
      background: var(--red);
      color: var(--white);
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 700;
    }

    .nav-tab.active .nav-badge {
      background: var(--white);
      color: var(--teal-dark);
    }

    /* Main Content */
    .main { padding: 24px; max-width: 1600px; margin: 0 auto; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Cards */
    .card {
      background: var(--white);
      border: var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
    }

    .card-header {
      background: var(--grey-200);
      padding: 16px 20px;
      border-bottom: 2px solid var(--grey-900);
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-body { padding: 20px; }
    .card-body.no-padding { padding: 0; }

    /* Grid Layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    @media (max-width: 1200px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--white);
      border: var(--border);
      box-shadow: var(--shadow-sm);
      padding: 20px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--grey-600);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
    }

    .stat-value.warning { color: var(--yellow); }
    .stat-value.error { color: var(--red); }
    .stat-value.success { color: var(--green); }
    .stat-value.info { color: var(--blue); }

    /* Session Banner */
    .session-banner {
      background: var(--teal-light);
      border: var(--border);
      box-shadow: var(--shadow-sm);
      padding: 16px 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .session-banner.inactive {
      background: var(--grey-200);
    }

    .session-info {
      display: flex;
      gap: 32px;
      flex-wrap: wrap;
    }

    .session-stat {
      display: flex;
      flex-direction: column;
    }

    .session-stat-label {
      font-size: 0.75rem;
      color: var(--grey-700);
      text-transform: uppercase;
      font-weight: 600;
    }

    .session-stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      font-weight: 700;
    }

    /* Multi-Session Bar */
    .session-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .session-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 2px solid var(--grey-300);
      background: var(--white);
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.15s;
    }

    .session-pill:hover {
      border-color: var(--grey-900);
    }

    .session-pill.active {
      border-color: var(--grey-900);
      background: var(--grey-100);
      box-shadow: 2px 2px 0px var(--grey-900);
    }

    .session-pill .pill-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .session-pill .pill-count {
      color: var(--grey-500);
      font-weight: 400;
    }

    .session-show-all {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border: 2px solid var(--grey-300);
      background: var(--white);
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.15s;
    }

    .session-show-all:hover {
      border-color: var(--grey-900);
    }

    .session-show-all.active {
      background: var(--grey-900);
      color: var(--white);
      border-color: var(--grey-900);
    }

    /* Session color stripe on command items */
    .command-session-stripe {
      width: 4px;
      min-height: 100%;
      align-self: stretch;
      flex-shrink: 0;
      border-radius: 2px;
    }

    .command-session-id {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Live Feed */
    .live-feed {
      max-height: 500px;
      overflow-y: auto;
    }

    .command-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--grey-200);
      transition: background 0.15s;
    }

    .command-item:hover {
      background: var(--grey-50);
    }

    .command-item:last-child { border-bottom: none; }

    .command-item.blocked-item {
      position: relative;
      opacity: 0.65;
    }

    .command-item.blocked-item::after {
      content: 'BLOCKED';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-8deg);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--red);
      opacity: 0.3;
      letter-spacing: 0.1em;
      pointer-events: none;
      text-transform: uppercase;
    }

    .command-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-top: 8px;
      flex-shrink: 0;
    }

    .command-status.allowed { background: var(--green); }
    .command-status.blocked { background: var(--red); }

    .command-content { flex: 1; min-width: 0; }

    .command-repo-banner {
      display: inline-block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--white);
      padding: 1px 8px;
      margin-bottom: 4px;
      letter-spacing: 0.02em;
    }

    .command-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      word-break: break-all;
    }

    .command-meta {
      display: flex;
      gap: 16px;
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--grey-500);
    }

    .risk-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .risk-badge.safe { background: #dcfce7; color: #166534; }
    .risk-badge.caution { background: #fef9c3; color: #854d0e; }
    .risk-badge.dangerous { background: #fed7aa; color: #c2410c; }
    .risk-badge.critical { background: #fecaca; color: #991b1b; }

    /* Form Elements */
    .form-group { margin-bottom: 20px; }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .form-select, .form-input {
      width: 100%;
      padding: 12px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      border: 2px solid var(--grey-900);
      background: var(--white);
      transition: all 0.15s ease;
    }

    .form-select:focus, .form-input:focus {
      outline: none;
      box-shadow: 4px 4px 0px var(--teal);
    }

    /* Toggle Switch */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--grey-200);
    }

    .toggle-row:last-child { border-bottom: none; }

    .toggle-info h4 {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .toggle-info p {
      font-size: 0.85rem;
      color: var(--grey-600);
    }

    .toggle {
      position: relative;
      width: 52px;
      height: 28px;
      cursor: pointer;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--grey-300);
      border: 2px solid var(--grey-900);
      transition: 0.2s;
    }

    .toggle-slider:before {
      content: "";
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: var(--grey-900);
      transition: 0.2s;
    }

    .toggle input:checked + .toggle-slider {
      background: var(--teal);
    }

    .toggle input:checked + .toggle-slider:before {
      transform: translateX(24px);
      background: var(--white);
    }

    /* List Editor */
    .list-editor {
      border: 2px solid var(--grey-300);
      max-height: 300px;
      overflow-y: auto;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid var(--grey-200);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }

    .list-item:last-child { border-bottom: none; }
    .list-item:nth-child(even) { background: var(--grey-50); }

    .list-item-text {
      flex: 1;
      word-break: break-all;
    }

    .list-item-desc {
      color: var(--grey-500);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 0.75rem;
      margin-top: 2px;
    }

    .list-item-remove {
      background: none;
      border: none;
      color: var(--red);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0 8px;
      font-weight: bold;
    }

    .list-add {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .list-add input { flex: 1; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 0.9rem;
      border: var(--border);
      background: var(--white);
      color: var(--grey-900);
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0px var(--grey-900);
    }

    .btn-primary {
      background: var(--teal);
      color: var(--white);
    }

    .btn-danger {
      background: var(--red);
      color: var(--white);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.8rem;
      box-shadow: 2px 2px 0px var(--grey-900);
    }

    .btn-small:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0px var(--grey-900);
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th, .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--grey-200);
    }

    .data-table th {
      background: var(--grey-100);
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--grey-600);
    }

    .data-table tr:hover td {
      background: var(--grey-50);
    }

    .data-table td {
      font-size: 0.9rem;
    }

    /* Session List */
    .session-list-item {
      display: flex;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--grey-200);
      cursor: pointer;
      transition: background 0.15s;
    }

    .session-list-item:hover {
      background: var(--grey-50);
    }

    .session-list-item.active {
      background: var(--teal-light);
    }

    .session-status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 16px;
    }

    .session-status-indicator.active { background: var(--green); }
    .session-status-indicator.completed { background: var(--grey-400); }
    .session-status-indicator.crashed { background: var(--red); }

    .session-list-info { flex: 1; }

    .session-list-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .session-list-meta {
      font-size: 0.8rem;
      color: var(--grey-500);
      margin-top: 4px;
    }

    .session-list-stats {
      display: flex;
      gap: 24px;
      text-align: right;
    }

    .session-list-stat {
      display: flex;
      flex-direction: column;
    }

    .session-list-stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
    }

    .session-list-stat-label {
      font-size: 0.7rem;
      color: var(--grey-500);
      text-transform: uppercase;
    }

    /* Activity List */
    .activity-list { list-style: none; }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--grey-200);
    }

    .activity-item:last-child { border-bottom: none; }

    .activity-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      border: 2px solid var(--grey-900);
      flex-shrink: 0;
    }

    .activity-icon.info { background: var(--teal-light); }
    .activity-icon.warning { background: var(--yellow); }
    .activity-icon.error { background: var(--red); color: var(--white); }
    .activity-icon.ai { background: var(--purple); color: var(--white); }

    .activity-content { flex: 1; }

    .activity-message {
      font-size: 0.9rem;
      word-break: break-word;
    }

    .activity-meta {
      display: flex;
      gap: 16px;
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--grey-500);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Bro Status Panel */
    .bro-status-panel {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 20px;
      background: var(--grey-50);
      border-bottom: 2px solid var(--grey-300);
    }

    .bro-avatar {
      width: 64px;
      height: 64px;
      background: var(--purple);
      border: 3px solid var(--grey-900);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .bro-info { flex: 1; }

    .bro-title {
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bro-subtitle {
      font-size: 0.85rem;
      color: var(--grey-600);
      margin-top: 4px;
    }

    .bro-controls {
      display: flex;
      gap: 12px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--grey-500);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--grey-900);
      color: var(--white);
      font-family: 'JetBrains Mono', monospace;
      border: var(--border);
      box-shadow: var(--shadow);
      z-index: 1000;
      display: none;
    }

    .toast.success { background: var(--teal-dark); }
    .toast.error { background: var(--red); }
    .toast.show { display: block; animation: slideIn 0.3s ease; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      border: 2px solid var(--grey-300);
      background: var(--white);
      cursor: pointer;
      transition: all 0.15s;
    }

    .filter-btn:hover {
      border-color: var(--grey-900);
    }

    .filter-btn.active {
      background: var(--grey-900);
      color: var(--white);
      border-color: var(--grey-900);
    }

    /* Security Stats Row */
    .security-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .security-stats-row { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .security-stats-row { grid-template-columns: 1fr; }
    }

    /* Risk Distribution Bars */
    .risk-bar-container {
      margin-bottom: 12px;
    }

    .risk-bar-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .risk-bar-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--grey-600);
    }

    .risk-bar-track {
      height: 24px;
      background: var(--grey-200);
      border: 2px solid var(--grey-900);
      position: relative;
      overflow: hidden;
    }

    .risk-bar-fill {
      height: 100%;
      transition: width 0.4s ease;
    }

    .risk-bar-fill.safe { background: var(--green); }
    .risk-bar-fill.caution { background: var(--yellow); }
    .risk-bar-fill.dangerous { background: var(--orange); }
    .risk-bar-fill.critical { background: var(--red); }

    /* Violation Type Rows */
    .violation-type-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--grey-200);
      font-size: 0.9rem;
    }

    .violation-type-row:last-child { border-bottom: none; }

    .violation-type-name {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
    }

    .violation-type-count {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      color: var(--red);
      background: #fecaca;
      padding: 2px 10px;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    /* Blocked Command Items */
    .blocked-cmd-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--grey-200);
      transition: background 0.15s;
    }

    .blocked-cmd-item:hover { background: var(--grey-50); }
    .blocked-cmd-item:last-child { border-bottom: none; }

    .blocked-cmd-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      word-break: break-all;
    }

    .blocked-cmd-meta {
      display: flex;
      gap: 12px;
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--grey-500);
      flex-wrap: wrap;
      align-items: center;
    }

    .blocked-cmd-violation {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      padding: 1px 6px;
      background: var(--grey-100);
      border: 1px solid var(--grey-300);
      border-radius: 3px;
    }

    /* Security Event Feed */
    .event-feed-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--grey-200);
      font-size: 0.85rem;
    }

    .event-feed-item:last-child { border-bottom: none; }

    .event-level-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .event-level-badge.warn { background: #fef9c3; color: #854d0e; }
    .event-level-badge.error { background: #fecaca; color: #991b1b; }

    .event-feed-message {
      flex: 1;
      min-width: 0;
      word-break: break-word;
    }

    .event-feed-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--grey-500);
      flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-tabs { flex-wrap: nowrap; }
      .nav-tab { flex: none; padding: 12px 16px; font-size: 0.8rem; }
      .main { padding: 16px; }
      .session-banner { flex-direction: column; }
      .session-info { gap: 16px; }
      .header { flex-direction: column; gap: 12px; }
      .bro-status-panel { flex-direction: column; text-align: center; }
    }

    /* Agent Integration Row */
    .agent-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .agent-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border: 2px solid var(--grey-300);
      background: var(--white);
      font-size: 0.85rem;
      font-weight: 600;
      position: relative;
    }

    .agent-chip.integrated {
      border-color: var(--green);
      background: #dcfce7;
    }

    .agent-chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-chip-dot.active { background: var(--green); }
    .agent-chip-dot.detected { background: var(--yellow); }
    .agent-chip-dot.not-found { background: var(--grey-400); }

    .agent-chip-detail {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--grey-500);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Advanced Config */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px 32px;
    }

    @media (max-width: 768px) {
      .config-grid { grid-template-columns: 1fr; }
    }

    .config-section {
      min-width: 0;
    }

    .config-section-title {
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 2px solid var(--grey-200);
    }

    .config-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      padding: 3px 0;
      font-size: 0.82rem;
    }

    .config-key {
      color: var(--grey-600);
      font-weight: 500;
      flex-shrink: 0;
    }

    .config-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      text-align: right;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .config-list {
      list-style: none;
      padding: 0;
      margin: 2px 0 6px 0;
      max-height: 96px;
      overflow-y: auto;
    }

    .config-list-item {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      padding: 2px 8px;
      background: var(--grey-50);
      margin-bottom: 1px;
      border-left: 3px solid var(--grey-300);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Editable config inputs */
    .config-input {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      padding: 4px 8px;
      border: 2px solid var(--grey-300);
      background: var(--white);
      width: 120px;
      text-align: right;
      transition: border-color 0.15s ease;
    }
    .config-input:focus {
      outline: none;
      border-color: var(--teal);
      box-shadow: 2px 2px 0px var(--teal);
    }

    .config-select {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      padding: 4px 8px;
      border: 2px solid var(--grey-300);
      background: var(--white);
      cursor: pointer;
      transition: border-color 0.15s ease;
    }
    .config-select:focus {
      outline: none;
      border-color: var(--teal);
      box-shadow: 2px 2px 0px var(--teal);
    }

    .config-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--teal);
    }

    .config-inline-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .config-inline-group .config-input {
      width: 60px;
    }
    .config-inline-group span {
      font-size: 0.75rem;
      color: var(--grey-500);
    }

    .config-path-list {
      border: 2px solid var(--grey-300);
      max-height: 150px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .config-path-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      border-bottom: 1px solid var(--grey-200);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
    }
    .config-path-item:last-child { border-bottom: none; }
    .config-path-item:nth-child(even) { background: var(--grey-50); }

    .config-path-remove {
      background: none;
      border: none;
      color: var(--red);
      cursor: pointer;
      font-size: 1rem;
      padding: 0 4px;
      font-weight: bold;
    }

    .config-path-add {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .config-path-add input {
      flex: 1;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      padding: 4px 8px;
      border: 2px solid var(--grey-300);
      background: var(--white);
    }
    .config-path-add input:focus {
      outline: none;
      border-color: var(--teal);
    }
    .config-path-add button {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      padding: 4px 10px;
      border: 2px solid var(--grey-900);
      background: var(--grey-200);
      cursor: pointer;
      font-weight: 600;
    }
    .config-path-add button:hover {
      background: var(--teal);
      color: var(--white);
    }

    /* Model Cards */
    .model-card {
      background: var(--white);
      border: var(--border);
      box-shadow: var(--shadow-sm);
      padding: 16px;
    }

    .model-card-name {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 8px;
      word-break: break-all;
    }

    .model-card-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--grey-600);
      margin-bottom: 12px;
    }

    .model-card-meta span {
      font-family: 'JetBrains Mono', monospace;
    }

    .model-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .model-tag {
      display: inline-block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .model-tag.family { background: #e0e7ff; color: #3730a3; }
    .model-tag.quant { background: #fef3c7; color: #92400e; }
    .model-tag.size { background: #d1fae5; color: #065f46; }
    .model-tag.purpose { background: #f3e8ff; color: #6b21a8; }
    .model-tag.score { background: #fce7f3; color: #9d174d; }

    /* Running model bar */
    .running-model-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--grey-200);
    }
    .running-model-bar:last-child { border-bottom: none; }

    .vram-bar-track {
      flex: 1;
      height: 20px;
      background: var(--grey-200);
      border: 2px solid var(--grey-900);
      position: relative;
      min-width: 100px;
    }

    .vram-bar-fill {
      height: 100%;
      background: var(--purple);
      transition: width 0.4s ease;
    }

    .vram-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    /* Profile item */
    .profile-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--grey-200);
    }
    .profile-item:last-child { border-bottom: none; }

    .profile-item-name {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
    }
    .profile-item-base {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    .profile-item-adapters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    /* Memory File Editor */
    .memory-file-section {
      margin-bottom: 24px;
      border: 2px solid var(--grey-300);
    }

    .memory-file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--grey-100);
      border-bottom: 2px solid var(--grey-300);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .memory-file-editor {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      line-height: 1.6;
      border: none;
      resize: vertical;
      background: var(--white);
    }

    .memory-file-editor:focus {
      outline: none;
      box-shadow: inset 0 0 0 2px var(--teal);
    }

    /* Settings Layout */
    .settings-layout {
      display: flex;
      gap: 24px;
    }

    .settings-subtabs {
      display: flex;
      flex-direction: column;
      gap: 0;
      background: var(--white);
      border: var(--border);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
      width: 200px;
      align-self: flex-start;
      position: sticky;
      top: 80px;
    }

    .settings-subtab {
      padding: 12px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      font-weight: 600;
      border: none;
      background: transparent;
      cursor: pointer;
      text-align: left;
      border-bottom: 1px solid var(--grey-200);
    }

    .settings-subtab:last-child { border-bottom: none; }
    .settings-subtab:hover { background: var(--grey-100); }
    .settings-subtab.active { background: var(--teal); color: var(--white); }

    .settings-content {
      flex: 1;
      min-width: 0;
    }

    .settings-subcontent { display: none; }
    .settings-subcontent.active { display: block; }

    @media (max-width: 768px) {
      .settings-layout { flex-direction: column; }
      .settings-subtabs {
        flex-direction: row;
        width: 100%;
        position: static;
        overflow-x: auto;
      }
      .settings-subtab { border-bottom: none; border-right: 1px solid var(--grey-200); white-space: nowrap; }
      .settings-subtab:last-child { border-right: none; }
    }

    /* ─── Achievements Page ─── */

    .player-card {
      background: linear-gradient(135deg, var(--teal-dark), var(--teal));
      border: var(--border);
      box-shadow: var(--shadow-sm);
      padding: 16px 24px;
      margin-bottom: 16px;
      color: var(--white);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .player-info { display: flex; flex-direction: column; gap: 2px; }

    .player-username {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .player-callsign {
      font-size: 0.82rem;
      opacity: 0.85;
      font-style: italic;
    }

    .player-meta {
      display: flex;
      gap: 16px;
      margin-top: 4px;
      font-size: 0.72rem;
      opacity: 0.75;
    }

    .player-top-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .player-top-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      font-weight: 600;
      border: 2px solid rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.1);
      color: var(--white);
    }
    .player-top-badge.ptb-3 { border-color: #fbbf24; color: #fde68a; }
    .player-top-badge.ptb-4 { border-color: #60a5fa; color: #bfdbfe; }
    .player-top-badge.ptb-5 { border-color: var(--teal-light); color: var(--teal-light); background: rgba(0,0,0,0.25); }

    .player-rank-section {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      min-width: 220px;
    }

    .rank-badge {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 1rem;
      padding: 4px 14px;
      border: 2px solid var(--white);
      background: rgba(255,255,255,0.15);
    }
    .rank-badge.rank-bronze { border-color: #a0a0a0; color: #d0d0d0; }
    .rank-badge.rank-silver { border-color: #c0c0c0; color: #e0e0e0; }
    .rank-badge.rank-gold { border-color: #fbbf24; color: #fbbf24; background: rgba(251,191,36,0.15); }
    .rank-badge.rank-diamond { border-color: #60a5fa; color: #93c5fd; background: rgba(59,130,246,0.12); animation: shimmer 3s ease-in-out infinite; }
    .rank-badge.rank-obsidian { border-color: var(--teal-light); color: var(--teal-light); background: var(--grey-900); }

    @keyframes shimmer {
      0%, 100% { box-shadow: 0 0 8px rgba(59,130,246,0.3); }
      50% { box-shadow: 0 0 20px rgba(59,130,246,0.6); }
    }

    .xp-bar-wrap {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .xp-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      font-family: 'JetBrains Mono', monospace;
      opacity: 0.85;
    }

    .xp-bar {
      height: 10px;
      border: 2px solid var(--white);
      background: rgba(255,255,255,0.15);
      overflow: hidden;
    }

    .xp-bar-fill {
      height: 100%;
      background: var(--white);
      transition: width 0.5s ease;
    }

    /* Achievement Category Layout */
    .ach-categories {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .ach-category {
      background: var(--white);
      border: var(--border);
      box-shadow: var(--shadow-sm);
    }

    .ach-category.full-width {
      grid-column: 1 / -1;
    }

    .ach-category-header {
      background: var(--grey-200);
      padding: 12px 16px;
      border-bottom: 2px solid var(--grey-900);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--grey-700);
    }

    .ach-category-body {
      padding: 16px;
    }

    .ach-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 12px;
    }

    .ach-stat-card {
      background: var(--grey-50);
      border: 2px solid var(--grey-300);
      padding: 12px 14px;
    }

    .ach-stat-icon { font-size: 1.1rem; margin-bottom: 4px; }

    .ach-stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ach-stat-label {
      font-size: 0.8rem;
      color: var(--grey-600);
      margin-top: 4px;
      font-weight: 500;
    }

    .ach-stat-sub {
      font-size: 0.72rem;
      color: var(--grey-500);
      margin-top: 2px;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Agent bar within stat card */
    .agent-share-bar {
      height: 5px;
      background: var(--grey-200);
      margin-top: 6px;
      overflow: hidden;
    }
    .agent-share-fill {
      height: 100%;
      background: var(--teal);
    }

    @media (max-width: 1000px) {
      .ach-categories { grid-template-columns: 1fr; }
      .ach-stats-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }

    /* Badge Wall */
    .badge-wall {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .badge-card {
      background: var(--white);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .badge-card.tier-0 { border: 2px dashed var(--grey-400); opacity: 0.55; }
    .badge-card.tier-1 { border: 2px solid var(--grey-800); }
    .badge-card.tier-2 { border: 2px solid var(--grey-500); box-shadow: 2px 2px 0 var(--grey-400); }
    .badge-card.tier-3 { border: 2px solid #fbbf24; box-shadow: 2px 2px 0 #fbbf24; background: #fffbeb; }
    .badge-card.tier-4 { border: 2px solid #3b82f6; box-shadow: 2px 2px 0 var(--grey-900); animation: shimmer 3s ease-in-out infinite; }
    .badge-card.tier-5 { border: 2px solid var(--teal); box-shadow: 3px 3px 0 var(--grey-900); background: var(--grey-900); color: var(--white); }

    .badge-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-icon { font-size: 1.3rem; }
    .badge-card.tier-5 .badge-icon { filter: brightness(1.2); }

    .badge-name {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .badge-desc {
      font-size: 0.75rem;
      color: var(--grey-500);
    }
    .badge-card.tier-5 .badge-desc { color: var(--grey-400); }

    .badge-tier-dots {
      display: flex;
      gap: 4px;
    }

    .tier-dot {
      width: 12px;
      height: 12px;
      border: 2px solid var(--grey-400);
      background: transparent;
    }
    .tier-dot.filled { background: var(--grey-400); }
    .tier-dot.tier-1.filled { background: var(--grey-800); border-color: var(--grey-800); }
    .tier-dot.tier-2.filled { background: var(--grey-500); border-color: var(--grey-500); }
    .tier-dot.tier-3.filled { background: #fbbf24; border-color: #fbbf24; }
    .tier-dot.tier-4.filled { background: #3b82f6; border-color: #3b82f6; }
    .tier-dot.tier-5.filled { background: var(--teal); border-color: var(--teal); }

    .badge-progress-bar {
      height: 5px;
      background: var(--grey-200);
      overflow: hidden;
      margin-top: 4px;
    }
    .badge-card.tier-5 .badge-progress-bar { background: var(--grey-700); }

    .badge-progress-fill {
      height: 100%;
      background: var(--teal);
    }

    .badge-progress-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--grey-500);
      text-align: right;
    }
    .badge-card.tier-5 .badge-progress-text { color: var(--grey-400); }

    @media (max-width: 768px) {
      .player-card { flex-direction: column; align-items: stretch; padding: 14px; }
      .player-rank-section { align-items: stretch; min-width: 0; }
      .ach-categories { grid-template-columns: 1fr; }
      .badge-wall { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }

  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <span class="logo-slash">/</span>BashBros Dashboard
    </div>
    <div class="header-right">
      <div class="connection-status">
        <span class="status-dot" id="connectionDot"></span>
        <span id="connectionText">Connecting...</span>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="nav-tabs">
    <button class="nav-tab active" data-tab="live">Live</button>
    <button class="nav-tab" data-tab="sessions">Sessions</button>
    <button class="nav-tab" data-tab="security">Security <span class="nav-badge" id="securityBadge" style="display:none">0</span></button>
    <button class="nav-tab" data-tab="bro">Bash Bro</button>
    <button class="nav-tab" data-tab="models">Models</button>
    <button class="nav-tab" data-tab="context">Context</button>
    <button class="nav-tab" data-tab="achievements">Achievements</button>
    <button class="nav-tab" data-tab="settings">Settings</button>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <!-- Live Tab -->
    <div id="live" class="tab-content active">
      <!-- Multi-Session Bar -->
      <div class="session-banner" id="sessionBanner">
        <div class="session-pills" id="sessionPills">
          <span style="font-weight:600; font-size:0.85rem; margin-right:4px;">Sessions:</span>
          <span style="color:var(--grey-500); font-size:0.85rem;">No active sessions</span>
        </div>
        <div>
          <button class="session-show-all active" id="showAllBtn" onclick="selectLiveSession(null)">Show All</button>
        </div>
      </div>

      <div class="grid-2">
        <!-- Live Command Feed -->
        <div class="card">
          <div class="card-header">
            Live Command Feed
            <span style="font-size: 0.8rem; color: var(--grey-500);">Auto-updating</span>
          </div>
          <div class="card-body no-padding">
            <div class="live-feed" id="liveCommandFeed">
              <div class="empty-state">Waiting for commands...</div>
            </div>
          </div>
        </div>

        <!-- Recent Violations -->
        <div class="card">
          <div class="card-header">Recent Violations</div>
          <div class="card-body no-padding">
            <div class="live-feed" id="recentViolations">
              <div class="empty-state">No violations</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Today's Commands</div>
          <div class="stat-value" id="todayCommands">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Today's Violations</div>
          <div class="stat-value error" id="todayViolations">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Risk (24h)</div>
          <div class="stat-value" id="avgRisk24h">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ollama Status</div>
          <div class="stat-value" id="ollamaStatusStat">-</div>
        </div>
      </div>
    </div>

    <!-- Sessions Tab -->
    <div id="sessions" class="tab-content">
      <div class="filter-bar">
        <button class="filter-btn active" data-filter="all" onclick="filterSessions('all')">All</button>
        <button class="filter-btn" data-filter="today" onclick="filterSessions('today')">Today</button>
        <button class="filter-btn" data-filter="week" onclick="filterSessions('week')">This Week</button>
        <button class="filter-btn" data-filter="month" onclick="filterSessions('month')">This Month</button>
      </div>

      <div class="grid-2">
        <!-- Session List -->
        <div class="card">
          <div class="card-header">Sessions</div>
          <div class="card-body no-padding">
            <div id="sessionList" style="max-height: 600px; overflow-y: auto;">
              <div class="empty-state">No sessions recorded</div>
            </div>
          </div>
        </div>

        <!-- Session Detail -->
        <div class="card">
          <div class="card-header">Session Detail</div>
          <div class="card-body" id="sessionDetail" style="max-height: 640px; overflow-y: auto;">
            <div class="empty-state">Select a session to view details</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Security Tab -->
    <div id="security" class="tab-content">
      <!-- 1. Violation Summary (Last 24h) -->
      <div class="card">
        <div class="card-header">Violation Summary (Last 24h)</div>
        <div class="card-body">
          <div id="violationSummary">
            <div class="empty-state">Loading...</div>
          </div>
        </div>
      </div>

      <!-- 2. Blocked Commands Log -->
      <div class="card">
        <div class="card-header">
          Blocked Commands Log
          <button class="btn btn-small" onclick="fetchBlockedCommands()">Refresh</button>
        </div>
        <div class="card-body no-padding">
          <div class="live-feed" id="blockedCommandsList">
            <div class="empty-state">No blocked commands</div>
          </div>
        </div>
      </div>

      <!-- 3. Security Events Feed -->
      <div class="card">
        <div class="card-header">
          Security Events Feed
          <button class="btn btn-small" onclick="fetchSecurityEvents()">Refresh</button>
        </div>
        <div class="card-body no-padding">
          <div class="live-feed" id="securityEventsFeed">
            <div class="empty-state">No security events</div>
          </div>
        </div>
      </div>

      <!-- 4. Pending Egress Blocks -->
      <div class="card">
        <div class="card-header">
          Pending Egress Blocks
          <button class="btn btn-small" onclick="fetchBlocked()">Refresh</button>
        </div>
        <div class="card-body no-padding">
          <table class="data-table">
            <thead>
              <tr>
                <th>Pattern</th>
                <th>Matched Text</th>
                <th>Connector</th>
                <th>Time</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="egressBlocksTable">
              <tr><td colspan="5" class="empty-state">No pending blocks</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 5. Network Exposure Scans -->
      <div class="card">
        <div class="card-header">
          Network Exposure Scans
          <button class="btn btn-small" onclick="fetchExposures()">Refresh</button>
        </div>
        <div class="card-body no-padding">
          <table class="data-table">
            <thead>
              <tr>
                <th>Severity</th>
                <th>Port</th>
                <th>Bind Address</th>
                <th>Agent</th>
                <th>Has Auth</th>
                <th>Action</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody id="exposuresTable">
              <tr><td colspan="7" class="empty-state">No exposure scans</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bash Bro Tab -->
    <div id="bro" class="tab-content">
      <!-- Bro Status Panel -->
      <div class="card">
        <div class="bro-status-panel">
          <div class="bro-avatar">AI</div>
          <div class="bro-info">
            <div class="bro-title">
              Bash Bro
              <span class="status-dot" id="broStatusDot"></span>
            </div>
            <div class="bro-subtitle" id="broModelInfo">Checking Ollama connection...</div>
          </div>
          <div class="bro-controls">
            <select class="form-select" id="modelSelect" style="width: auto; min-width: 200px;">
              <option value="">Loading models...</option>
            </select>
            <button class="btn btn-primary btn-small" onclick="changeModel()">Apply</button>
            <button class="btn btn-small" onclick="triggerScan()">Scan System</button>
          </div>
        </div>

        <div class="card-body">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Platform</div>
              <div class="stat-value" id="broPlatform" style="font-size: 1.2rem;">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Shell</div>
              <div class="stat-value" id="broShell" style="font-size: 1.2rem;">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Project Type</div>
              <div class="stat-value" id="broProjectType" style="font-size: 1.2rem;">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">AI Requests Today</div>
              <div class="stat-value info" id="broRequestsToday">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Active Profile</div>
              <div class="stat-value" id="broActiveProfile" style="font-size: 1rem;">None</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Adapters Active</div>
              <div class="stat-value info" id="broAdaptersActive">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bro Activity Log -->
      <div class="card">
        <div class="card-header">
          AI Activity Log
          <button class="btn btn-small" onclick="fetchBroEvents()">Refresh</button>
        </div>
        <div class="card-body">
          <ul class="activity-list" id="broActivityLog">
            <li class="empty-state">No AI activity recorded</li>
          </ul>
        </div>
      </div>

      <!-- Router Stats -->
      <div class="card">
        <div class="card-header">
          Router Stats
          <button class="btn btn-small" onclick="fetchRouterStats()">Refresh</button>
        </div>
        <div class="card-body">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Pattern-Matched</div>
              <div class="stat-value success" id="routerPatternCount">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">AI-Routed</div>
              <div class="stat-value info" id="routerAiCount">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Confidence</div>
              <div class="stat-value" id="routerAvgConfidence" style="font-size:1.2rem;">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Adapter Events -->
      <div class="card">
        <div class="card-header">
          Adapter Events
          <button class="btn btn-small" onclick="fetchAdapterEvents()">Refresh</button>
        </div>
        <div class="card-body no-padding">
          <table class="data-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Adapter</th>
                <th>Base Model</th>
                <th>Purpose</th>
                <th>Action</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="adapterEventsTable">
              <tr><td colspan="6" class="empty-state">No adapter events recorded</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Models Tab -->
    <div id="models" class="tab-content">
      <!-- Pull Model Bar -->
      <div class="card">
        <div class="card-header">Pull Model</div>
        <div class="card-body">
          <div style="display:flex; gap:12px; align-items:center;">
            <input class="form-input" id="pullModelInput" placeholder="e.g. deepseek-coder:6.7b" style="flex:1;">
            <button class="btn btn-primary" onclick="pullModel()">Pull</button>
          </div>
          <div id="pullStatus" style="margin-top:12px; display:none;">
            <div style="font-family:'JetBrains Mono',monospace; font-size:0.85rem;" id="pullStatusText">Pulling...</div>
            <div style="height:8px; background:var(--grey-200); border:2px solid var(--grey-900); margin-top:8px;">
              <div id="pullProgressBar" style="height:100%; background:var(--teal); width:0%; transition:width 0.3s;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Running Models -->
      <div class="card">
        <div class="card-header">Running Models <button class="btn btn-small" onclick="fetchRunningModels()">Refresh</button></div>
        <div class="card-body" id="runningModelsContainer">
          <div class="empty-state">Loading...</div>
        </div>
      </div>

      <!-- Installed Models -->
      <div class="card">
        <div class="card-header">Installed Models <button class="btn btn-small" onclick="fetchInstalledModels()">Refresh</button></div>
        <div class="card-body">
          <div class="grid-3" id="installedModelsGrid">
            <div class="empty-state">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Adapters -->
      <div class="card">
        <div class="card-header">LoRA Adapters <button class="btn btn-small" onclick="fetchAdapters()">Refresh</button></div>
        <div class="card-body">
          <div class="grid-3" id="adaptersGrid">
            <div class="empty-state">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Profiles -->
      <div class="card">
        <div class="card-header">Model Profiles <button class="btn btn-small" onclick="fetchProfiles()">Refresh</button></div>
        <div class="card-body">
          <div id="profilesList" style="margin-bottom:20px;">
            <div class="empty-state">Loading...</div>
          </div>
          <div style="border-top:2px solid var(--grey-200); padding-top:20px;">
            <h4 style="margin-bottom:12px; font-weight:700;">Create / Edit Profile</h4>
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Profile Name</label>
                <input class="form-input" id="profileName" placeholder="e.g. balanced">
              </div>
              <div class="form-group">
                <label class="form-label">Base Model</label>
                <input class="form-input" id="profileBaseModel" placeholder="e.g. qwen2.5-coder:7b">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Adapter Assignments (purpose → adapter name)</label>
              <div class="grid-3" style="gap:12px;">
                <div><label style="font-size:0.8rem; color:var(--grey-600);">suggest</label><input class="form-input" id="profileAdapterSuggest" placeholder="adapter name"></div>
                <div><label style="font-size:0.8rem; color:var(--grey-600);">safety</label><input class="form-input" id="profileAdapterSafety" placeholder="adapter name"></div>
                <div><label style="font-size:0.8rem; color:var(--grey-600);">route</label><input class="form-input" id="profileAdapterRoute" placeholder="adapter name"></div>
                <div><label style="font-size:0.8rem; color:var(--grey-600);">explain</label><input class="form-input" id="profileAdapterExplain" placeholder="adapter name"></div>
                <div><label style="font-size:0.8rem; color:var(--grey-600);">fix</label><input class="form-input" id="profileAdapterFix" placeholder="adapter name"></div>
                <div><label style="font-size:0.8rem; color:var(--grey-600);">script</label><input class="form-input" id="profileAdapterScript" placeholder="adapter name"></div>
              </div>
            </div>
            <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Context Tab -->
    <div id="context" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Last Updated</div>
          <div class="stat-value" id="ctxLastUpdated" style="font-size:1rem;">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Agents Seen</div>
          <div class="stat-value info" id="ctxAgents">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Sessions</div>
          <div class="stat-value" id="ctxSessions">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Command Files</div>
          <div class="stat-value" id="ctxCommands">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Error Files</div>
          <div class="stat-value error" id="ctxErrors">0</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          Memory Files
          <button class="btn btn-small" onclick="fetchContextMemory()">Refresh</button>
        </div>
        <div class="card-body" id="memoryFilesContainer">
          <div class="empty-state">Loading memory files...</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Session Browser</div>
        <div class="card-body">
          <div class="empty-state">
            Session browsing coming soon. Memory files and context index are available above.
          </div>
        </div>
      </div>
    </div>

    <!-- Achievements Tab -->
    <div id="achievements" class="tab-content">
      <div id="playerCard" class="player-card">
        <div class="player-info">
          <div class="player-username" id="achUsername">--</div>
          <div class="player-callsign" id="achCallsign">Loading...</div>
          <div class="player-top-badges" id="achTopBadges"></div>
          <div class="player-meta" id="achMeta"></div>
        </div>
        <div class="player-rank-section">
          <div class="rank-badge" id="achRankBadge">--</div>
          <div class="xp-bar-wrap">
            <div class="xp-bar-labels">
              <span id="achXpCurrent">0 XP</span>
              <span id="achXpNext">-- XP</span>
            </div>
            <div class="xp-bar"><div class="xp-bar-fill" id="achXpFill" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <div class="ach-categories" id="achStatsContainer"></div>

      <div class="ach-category full-width" style="margin-bottom:20px;">
        <div class="ach-category-header">Badge Wall</div>
        <div class="ach-category-body">
          <div class="badge-wall" id="achBadgeWall">
            <div class="empty-state">Loading badges...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
      <div class="settings-layout">
        <!-- Left sidebar -->
        <div class="settings-subtabs">
          <button class="settings-subtab active" data-settings-tab="general">General</button>
          <button class="settings-subtab" data-settings-tab="allowed-cmds">Allowed Cmds</button>
          <button class="settings-subtab" data-settings-tab="blocked-cmds">Blocked Cmds</button>
          <button class="settings-subtab" data-settings-tab="paths">Paths</button>
        </div>

        <!-- Right content area -->
        <div class="settings-content">
          <!-- General sub-tab (default) -->
          <div id="settings-general" class="settings-subcontent active">
            <!-- Agent Integrations -->
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px; flex-wrap:wrap;">
              <span style="font-weight:700; font-size:0.85rem; color:var(--grey-600);">Agents:</span>
              <div class="agent-row" id="agentGrid">
                <span style="color:var(--grey-500); font-size:0.85rem;">Loading...</span>
              </div>
              <button class="btn btn-small" onclick="loadAgentStatus()" style="margin-left:auto;">Refresh</button>
            </div>

            <!-- Security Profile + Data Retention side by side -->
            <div class="grid-2">
              <div class="card">
                <div class="card-header">Security Profile</div>
                <div class="card-body">
                  <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Profile</label>
                    <select class="form-select" id="profileSelect">
                      <option value="permissive">Permissive - Allow all, block dangerous</option>
                      <option value="balanced">Balanced - Explicit allowlist</option>
                      <option value="strict">Strict - Minimal access</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header">Data Retention</div>
                <div class="card-body">
                  <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Retention Period</label>
                    <select class="form-select" id="retentionSelect">
                      <option value="7">7 days</option>
                      <option value="14">14 days</option>
                      <option value="30" selected>30 days</option>
                      <option value="60">60 days</option>
                      <option value="90">90 days</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Security Features full-width -->
            <div class="card">
              <div class="card-header">Security Features</div>
              <div class="card-body">
                <div class="grid-2" style="gap: 0;">
                  <div>
                    <div class="toggle-row">
                      <div class="toggle-info">
                        <h4>Secrets Guard</h4>
                        <p>Block access to .env files, API keys, and credentials</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="secretsEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="toggle-row">
                      <div class="toggle-info">
                        <h4>Audit Log</h4>
                        <p>Record all command executions and violations</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="auditEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="toggle-row">
                      <div class="toggle-info">
                        <h4>Rate Limiter</h4>
                        <p>Prevent runaway agents with command rate limits</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="rateLimitEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="toggle-row">
                      <div class="toggle-info">
                        <h4>Risk Scoring</h4>
                        <p>Score commands by danger level (1-10)</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="riskScoringEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="toggle-row" style="border-bottom:none;">
                      <div class="toggle-info">
                        <h4>Loop Detection</h4>
                        <p>Detect stuck or repetitive agent behavior</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="loopDetectionEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  </div>
                  <div style="border-left: 1px solid var(--grey-200); padding-left: 24px;">
                    <div class="toggle-row">
                      <div class="toggle-info">
                        <h4>Anomaly Detection</h4>
                        <p>Flag unusual patterns and suspicious commands</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="anomalyDetectionEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="toggle-row">
                      <div class="toggle-info">
                        <h4>Output Scanning</h4>
                        <p>Detect and redact leaked secrets in output</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="outputScanningEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="toggle-row">
                      <div class="toggle-info">
                        <h4>Undo Stack</h4>
                        <p>Enable rollback of file changes</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="undoEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                    <div class="toggle-row" style="border-bottom:none;">
                      <div class="toggle-info">
                        <h4>Ward Security</h4>
                        <p>Network exposure and egress monitoring</p>
                      </div>
                      <label class="toggle">
                        <input type="checkbox" id="wardEnabled" checked>
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Configuration -->
            <div class="card">
              <div class="card-header">Advanced Configuration</div>
              <div class="card-body" id="advancedConfigBody">
                <div class="empty-state">Loading configuration...</div>
              </div>
            </div>

            <div style="margin-top: 20px;">
              <button class="btn btn-primary" onclick="saveConfig()">Save Changes</button>
            </div>
          </div>

          <!-- Allowed Commands sub-tab -->
          <div id="settings-allowed-cmds" class="settings-subcontent">
            <div class="card">
              <div class="card-header">Allowed Commands</div>
              <div class="card-body">
                <p style="margin-bottom: 12px; color: var(--grey-600); font-size: 0.9rem;">
                  Commands that are always allowed. Use * as wildcard.
                </p>
                <div class="list-editor" id="allowList"></div>
                <div class="list-add">
                  <input type="text" class="form-input" id="allowInput" placeholder="Add command pattern (e.g., docker *)">
                  <button class="btn btn-small" onclick="addToList('allow')">Add</button>
                </div>
              </div>
            </div>
            <div style="margin-top: 20px;">
              <button class="btn btn-primary" onclick="saveConfig()">Save Changes</button>
            </div>
          </div>

          <!-- Blocked Commands sub-tab -->
          <div id="settings-blocked-cmds" class="settings-subcontent">
            <div class="card">
              <div class="card-header">Blocked Commands</div>
              <div class="card-body">
                <p style="margin-bottom: 12px; color: var(--grey-600); font-size: 0.9rem;">
                  Commands that are always blocked, even in permissive mode.
                </p>
                <div class="list-editor" id="blockList"></div>
                <div class="list-add">
                  <input type="text" class="form-input" id="blockInput" placeholder="Add blocked pattern (e.g., rm -rf /*)">
                  <button class="btn btn-small" onclick="addToList('block')">Add</button>
                </div>
              </div>
            </div>
            <div style="margin-top: 20px;">
              <button class="btn btn-primary" onclick="saveConfig()">Save Changes</button>
            </div>
          </div>

          <!-- Path Restrictions sub-tab -->
          <div id="settings-paths" class="settings-subcontent">
            <div class="grid-2">
              <div class="card">
                <div class="card-header">Allowed Paths</div>
                <div class="card-body">
                  <p style="margin-bottom: 12px; color: var(--grey-600); font-size: 0.9rem;">
                    Paths the agent is allowed to access.
                  </p>
                  <div class="list-editor" id="pathAllowList"></div>
                  <div class="list-add">
                    <input type="text" class="form-input" id="pathAllowInput" placeholder="Add path pattern">
                    <button class="btn btn-small" onclick="addToList('pathAllow')">Add</button>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header">Blocked Paths</div>
                <div class="card-body">
                  <p style="margin-bottom: 12px; color: var(--grey-600); font-size: 0.9rem;">
                    Paths the agent is never allowed to access.
                  </p>
                  <div class="list-editor" id="pathBlockList"></div>
                  <div class="list-add">
                    <input type="text" class="form-input" id="pathBlockInput" placeholder="Add path pattern">
                    <button class="btn btn-small" onclick="addToList('pathBlock')">Add</button>
                  </div>
                </div>
              </div>
            </div>
            <div style="margin-top: 20px;">
              <button class="btn btn-primary" onclick="saveConfig()">Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // State
    let config = null;
    let ws = null;
    let activeTab = 'live';
    let selectedSessionId = null;
    let livePollingInterval = null;
    let backgroundPollingInterval = null;
    let lastCommandId = null;
    let activeSessions = [];
    let selectedLiveSessionId = null;

    // Session color palette (8 colors)
    const SESSION_COLORS = [
      '#4DB6AC', // teal
      '#f97316', // orange
      '#8b5cf6', // purple
      '#22c55e', // green
      '#3b82f6', // blue
      '#eab308', // yellow
      '#ec4899', // pink
      '#06b6d4', // cyan
    ];

    // Map session IDs to colors (stable assignment)
    const sessionColorMap = new Map();
    let nextColorIndex = 0;

    function getSessionColor(sessionId) {
      if (!sessionColorMap.has(sessionId)) {
        sessionColorMap.set(sessionId, SESSION_COLORS[nextColorIndex % SESSION_COLORS.length]);
        nextColorIndex++;
      }
      return sessionColorMap.get(sessionId);
    }

    // DOM Elements
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const toast = document.getElementById('toast');

    // Tab Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        const tabId = tab.dataset.tab;
        document.getElementById(tabId).classList.add('active');
        activeTab = tabId;
        onTabChange(tabId);
      });
    });

    // Settings Sub-tab Navigation
    document.querySelectorAll('.settings-subtab').forEach(btn => {
      btn.addEventListener('click', () => {
        switchSettingsTab(btn.dataset.settingsTab);
      });
    });

    function switchSettingsTab(tabId) {
      document.querySelectorAll('.settings-subtab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.settings-subcontent').forEach(c => c.classList.remove('active'));
      const btn = document.querySelector(`.settings-subtab[data-settings-tab="${tabId}"]`);
      if (btn) btn.classList.add('active');
      const panel = document.getElementById('settings-' + tabId);
      if (panel) panel.classList.add('active');
    }

    function onTabChange(tabId) {
      // Adjust polling based on active tab
      if (tabId === 'live') {
        startLivePolling();
      } else {
        stopLivePolling();
      }

      // Security polling
      if (tabId === 'security') {
        startSecurityPolling();
      } else {
        stopSecurityPolling();
      }

      // Load tab-specific data
      if (tabId === 'sessions') fetchSessions();
      if (tabId === 'bro') {
        fetchBroStatus();
        fetchBroModels();
        fetchBroEvents();
        fetchRouterStats();
        fetchAdapterEvents();
        fetchBroProfileInfo();
      }
      if (tabId === 'models') {
        fetchInstalledModels();
        fetchRunningModels();
        fetchAdapters();
        fetchProfiles();
      }
      if (tabId === 'context') {
        fetchContextIndex();
        fetchContextMemory();
      }
      if (tabId === 'achievements') {
        fetchAchievements();
      }
      if (tabId === 'settings') {
        loadConfig();
        loadAgentStatus();
      }
    }

    // Show Toast
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Connection Status
    function setConnectionStatus(connected) {
      connectionDot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
      connectionText.textContent = connected ? 'Connected' : 'Disconnected';
    }

    // ─────────────────────────────────────────────────────────────
    // Live Tab Functions
    // ─────────────────────────────────────────────────────────────

    function startLivePolling() {
      fetchLiveData();
      if (livePollingInterval) clearInterval(livePollingInterval);
      livePollingInterval = setInterval(fetchLiveData, 1000);
    }

    function stopLivePolling() {
      if (livePollingInterval) {
        clearInterval(livePollingInterval);
        livePollingInterval = null;
      }
    }

    // Cache keys for localStorage persistence across refreshes
    const CACHE_KEYS = {
      commands: 'bashbros_live_commands',
      sessions: 'bashbros_live_sessions',
      stats: 'bashbros_live_stats'
    };

    function cacheLiveData(key, data) {
      try { localStorage.setItem(key, JSON.stringify(data)); } catch {}
    }

    function getCachedData(key) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function restoreCachedFeed() {
      const commands = getCachedData(CACHE_KEYS.commands);
      if (commands && commands.length > 0) {
        renderLiveCommands(commands);
      }
      const sessions = getCachedData(CACHE_KEYS.sessions);
      if (sessions && sessions.length > 0) {
        activeSessions = sessions;
        updateSessionBanner(activeSessions);
      }
      const stats = getCachedData(CACHE_KEYS.stats);
      if (stats) {
        updateLiveStats(stats);
      }
    }

    async function fetchLiveData() {
      try {
        // Fetch all active sessions
        const sessionRes = await fetch('/api/sessions/active-all');
        const sessions = await sessionRes.json();
        activeSessions = sessions || [];
        updateSessionBanner(activeSessions);
        cacheLiveData(CACHE_KEYS.sessions, activeSessions);

        // Fetch live commands (with optional session filter)
        let commandsUrl = '/api/commands/live?limit=30';
        if (selectedLiveSessionId) {
          commandsUrl += `&sessionId=${encodeURIComponent(selectedLiveSessionId)}`;
        }
        const commandsRes = await fetch(commandsUrl);
        const commands = await commandsRes.json();
        renderLiveCommands(commands);
        cacheLiveData(CACHE_KEYS.commands, commands);

        // Fetch stats
        const statsRes = await fetch('/api/stats');
        const stats = await statsRes.json();
        updateLiveStats(stats);
        cacheLiveData(CACHE_KEYS.stats, stats);
      } catch (error) {
        console.error('Failed to fetch live data:', error);
      }
    }

    function updateSessionBanner(sessions) {
      const banner = document.getElementById('sessionBanner');
      const pillsContainer = document.getElementById('sessionPills');
      const showAllBtn = document.getElementById('showAllBtn');

      if (!sessions || sessions.length === 0) {
        banner.classList.add('inactive');
        pillsContainer.innerHTML = `
          <span style="font-weight:600; font-size:0.85rem; margin-right:4px;">Sessions:</span>
          <span style="color:var(--grey-500); font-size:0.85rem;">No active sessions</span>
        `;
        showAllBtn.classList.add('active');
        return;
      }

      banner.classList.remove('inactive');

      // Update Show All button state
      showAllBtn.classList.toggle('active', selectedLiveSessionId === null);

      // Build session pills
      let pillsHtml = '<span style="font-weight:600; font-size:0.85rem; margin-right:4px;">Sessions:</span>';
      for (const session of sessions) {
        const color = getSessionColor(session.id);
        const shortId = session.id.slice(0, 8);
        const isActive = selectedLiveSessionId === session.id;

        // Calculate duration
        const start = new Date(session.startTime);
        const duration = Math.floor((Date.now() - start.getTime()) / 1000);
        const mins = Math.floor(duration / 60);
        const secs = duration % 60;
        const durationStr = mins > 0 ? `${mins}m` : `${secs}s`;

        const repoLabel = session.repoName || session.workingDir.split(/[/\\]/).pop() || shortId;

        pillsHtml += `
          <button class="session-pill ${isActive ? 'active' : ''}"
                  onclick="selectLiveSession('${session.id}')"
                  title="${session.id} — ${session.workingDir}">
            <span class="pill-dot" style="background:${color}"></span>
            ${repoLabel}
            <span class="pill-count">${session.commandCount} cmds</span>
            <span class="pill-count">${durationStr}</span>
          </button>
        `;
      }

      pillsContainer.innerHTML = pillsHtml;
    }

    function selectLiveSession(sessionId) {
      selectedLiveSessionId = sessionId;
      // Immediately re-render banner to update active states
      updateSessionBanner(activeSessions);
      // Fetch new data with the filter
      fetchLiveData();
    }

    function renderCommandItem(cmd, showViolation) {
      const sessionColor = cmd.sessionId ? getSessionColor(cmd.sessionId) : 'var(--grey-300)';
      const shortSessionId = cmd.sessionId ? cmd.sessionId.slice(0, 6) : '';
      const repoLabel = cmd.repoName || '';

      return `
        <div class="command-item ${!cmd.allowed ? 'blocked-item' : ''}">
          <div class="command-session-stripe" style="background:${sessionColor}"></div>
          <div class="command-status ${cmd.allowed ? 'allowed' : 'blocked'}"></div>
          <div class="command-content">
            ${repoLabel ? `<div class="command-repo-banner" style="background:${sessionColor}">${escapeHtml(repoLabel)}</div>` : ''}
            <div class="command-text">${escapeHtml(cmd.command)}</div>
            <div class="command-meta">
              <span class="risk-badge ${cmd.riskLevel}">${showViolation && cmd.violations && cmd.violations.length > 0 ? cmd.violations[0] : cmd.riskLevel + ' (' + cmd.riskScore + ')'}</span>
              ${shortSessionId ? `<span class="command-session-id" style="color:${sessionColor}">${shortSessionId}</span>` : ''}
              <span>${formatTime(cmd.timestamp)}</span>
              ${!showViolation && cmd.durationMs ? `<span>${cmd.durationMs}ms</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function renderLiveCommands(commands) {
      const feed = document.getElementById('liveCommandFeed');
      const violations = document.getElementById('recentViolations');

      if (!commands || commands.length === 0) {
        feed.innerHTML = '<div class="empty-state">Waiting for commands...</div>';
        violations.innerHTML = '<div class="empty-state">No violations</div>';
        return;
      }

      // Render all commands
      feed.innerHTML = commands.map(cmd => renderCommandItem(cmd, false)).join('');

      // Render violations only
      const blockedCommands = commands.filter(c => !c.allowed);
      if (blockedCommands.length === 0) {
        violations.innerHTML = '<div class="empty-state">No violations</div>';
      } else {
        violations.innerHTML = blockedCommands.map(cmd => renderCommandItem(cmd, true)).join('');
      }
    }

    function updateLiveStats(stats) {
      document.getElementById('todayCommands').textContent = stats.todayCommands || 0;
      document.getElementById('todayViolations').textContent = stats.todayViolations || 0;
      document.getElementById('avgRisk24h').textContent = stats.avgRiskScore24h ? stats.avgRiskScore24h.toFixed(1) : '-';

      const ollamaEl = document.getElementById('ollamaStatusStat');
      if (stats.ollamaStatus === 'connected') {
        ollamaEl.textContent = 'ON';
        ollamaEl.className = 'stat-value success';
      } else if (stats.ollamaStatus === 'disconnected') {
        ollamaEl.textContent = 'OFF';
        ollamaEl.className = 'stat-value error';
      } else {
        ollamaEl.textContent = '-';
        ollamaEl.className = 'stat-value';
      }

      // Update security badge
      const badge = document.getElementById('securityBadge');
      if (stats.pendingBlocks > 0) {
        badge.textContent = stats.pendingBlocks;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Sessions Tab Functions
    // ─────────────────────────────────────────────────────────────

    let sessionFilter = 'all';

    function filterSessions(filter) {
      sessionFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      fetchSessions();
    }

    async function fetchSessions() {
      try {
        let url = '/api/sessions?limit=50';

        if (sessionFilter === 'today') {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          url += `&since=${today.toISOString()}`;
        } else if (sessionFilter === 'week') {
          const week = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
          url += `&since=${week.toISOString()}`;
        } else if (sessionFilter === 'month') {
          const month = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
          url += `&since=${month.toISOString()}`;
        }

        const response = await fetch(url);
        const sessions = await response.json();
        renderSessionList(sessions);

        // Auto-select first session if none selected
        if (!selectedSessionId && sessions && sessions.length > 0) {
          selectSession(sessions[0].id);
        }
      } catch (error) {
        console.error('Failed to fetch sessions:', error);
      }
    }

    function renderSessionList(sessions) {
      const list = document.getElementById('sessionList');

      if (!sessions || sessions.length === 0) {
        list.innerHTML = '<div class="empty-state">No sessions recorded</div>';
        return;
      }

      list.innerHTML = sessions.map(session => `
        <div class="session-list-item ${selectedSessionId === session.id ? 'active' : ''}"
             onclick="selectSession('${session.id}')">
          <div class="session-status-indicator ${session.status}"></div>
          <div class="session-list-info">
            <div class="session-list-title">${session.repoName || session.workingDir.split(/[/\\]/).pop() || session.agent} <span style="color:var(--grey-500); font-weight:400;">— ${session.id.slice(0, 8)}</span></div>
            <div class="session-list-meta">
              ${formatDateTime(session.startTime)}
              ${session.endTime ? ` - ${formatDateTime(session.endTime)}` : ' (active)'}
            </div>
          </div>
          <div class="session-list-stats">
            <div class="session-list-stat">
              <span class="session-list-stat-value">${session.commandCount}</span>
              <span class="session-list-stat-label">Commands</span>
            </div>
            <div class="session-list-stat">
              <span class="session-list-stat-value" style="color: var(--red)">${session.blockedCount}</span>
              <span class="session-list-stat-label">Blocked</span>
            </div>
            <div class="session-list-stat">
              <span class="session-list-stat-value">${session.avgRiskScore.toFixed(1)}</span>
              <span class="session-list-stat-label">Avg Risk</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function selectSession(sessionId) {
      selectedSessionId = sessionId;
      fetchSessions(); // Re-render to show selection

      try {
        // Fetch session details
        const [sessionRes, metricsRes, commandsRes] = await Promise.all([
          fetch(`/api/sessions/${sessionId}`),
          fetch(`/api/sessions/${sessionId}/metrics`),
          fetch(`/api/sessions/${sessionId}/commands?limit=20`)
        ]);

        const session = await sessionRes.json();
        const metrics = await metricsRes.json();
        const commands = await commandsRes.json();

        renderSessionDetail(session, metrics, commands);
      } catch (error) {
        console.error('Failed to fetch session detail:', error);
      }
    }

    function renderSessionDetail(session, metrics, commands) {
      const detail = document.getElementById('sessionDetail');

      detail.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 8px;">${session.repoName || session.workingDir.split(/[/\\]/).pop() || session.agent} <span style="font-weight:400; color:var(--grey-500);">— ${session.agent}</span></h3>
          <p style="color: var(--grey-600); font-size: 0.9rem;">
            ${session.workingDir}<br>
            Started: ${formatDateTime(session.startTime)}<br>
            ${session.endTime ? `Ended: ${formatDateTime(session.endTime)}` : 'Currently active'}
          </p>
        </div>

        <div class="stats-grid" style="margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-label">Total Commands</div>
            <div class="stat-value" style="font-size: 1.5rem;">${metrics.totalCommands}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Allowed</div>
            <div class="stat-value success" style="font-size: 1.5rem;">${metrics.allowedCommands}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Blocked</div>
            <div class="stat-value error" style="font-size: 1.5rem;">${metrics.blockedCommands}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Risk</div>
            <div class="stat-value" style="font-size: 1.5rem;">${metrics.avgRiskScore.toFixed(1)}</div>
          </div>
        </div>

        <h4 style="margin-bottom: 12px;">Risk Distribution</h4>
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
          ${Object.entries(metrics.riskDistribution).map(([level, count]) => `
            <div class="risk-badge ${level}" style="padding: 8px 16px; font-size: 0.9rem;">
              ${level}: ${count}
            </div>
          `).join('')}
        </div>

        <h4 style="margin-bottom: 12px;">Recent Commands</h4>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--grey-200);">
          ${commands.map(cmd => `
            <div class="command-item" style="padding: 8px 12px;">
              <div class="command-status ${cmd.allowed ? 'allowed' : 'blocked'}"></div>
              <div class="command-content">
                <div class="command-text" style="font-size: 0.85rem;">${escapeHtml(cmd.command)}</div>
                <div class="command-meta">
                  <span class="risk-badge ${cmd.riskLevel}">${cmd.riskScore}</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ─────────────────────────────────────────────────────────────
    // Security Tab Functions
    // ─────────────────────────────────────────────────────────────

    let securityPollingInterval = null;

    function startSecurityPolling() {
      fetchSecuritySummary();
      fetchBlockedCommands();
      fetchSecurityEvents();
      fetchBlocked();
      fetchExposures();
      if (securityPollingInterval) clearInterval(securityPollingInterval);
      securityPollingInterval = setInterval(() => {
        fetchSecuritySummary();
        fetchBlockedCommands();
        fetchSecurityEvents();
        fetchBlocked();
        fetchExposures();
      }, 10000);
    }

    function stopSecurityPolling() {
      if (securityPollingInterval) {
        clearInterval(securityPollingInterval);
        securityPollingInterval = null;
      }
    }

    // --- Violation Summary ---

    async function fetchSecuritySummary() {
      try {
        const response = await fetch('/api/security/summary');
        const summary = await response.json();
        renderSecuritySummary(summary);
      } catch (error) {
        console.error('Failed to fetch security summary:', error);
      }
    }

    function renderSecuritySummary(summary) {
      const el = document.getElementById('violationSummary');

      const total = summary.totalCommands24h || 0;
      const blocked = summary.blockedCount24h || 0;
      const avgRisk = summary.avgRiskScore24h != null ? summary.avgRiskScore24h.toFixed(1) : '0';
      const highRisk = summary.highRiskCount24h || 0;

      let html = `
        <div class="security-stats-row">
          <div class="stat-card">
            <div class="stat-label">Total Commands</div>
            <div class="stat-value" style="font-size: 1.5rem;">${total}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Blocked</div>
            <div class="stat-value error" style="font-size: 1.5rem;">${blocked}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Risk Score</div>
            <div class="stat-value" style="font-size: 1.5rem;">${avgRisk}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">High Risk</div>
            <div class="stat-value ${highRisk > 0 ? 'warning' : ''}" style="font-size: 1.5rem;">${highRisk}</div>
          </div>
        </div>
      `;

      // Risk distribution bars
      html += '<h4 style="margin-bottom: 12px;">Risk Distribution</h4>';
      html += renderRiskBars(summary.riskDistribution || {}, total);

      // Violation types
      if (summary.violationTypes && summary.violationTypes.length > 0) {
        html += '<h4 style="margin: 20px 0 12px;">Violation Types</h4>';
        html += summary.violationTypes.map(v => `
          <div class="violation-type-row">
            <span class="violation-type-name">${escapeHtml(v.type)}</span>
            <span class="violation-type-count">${v.count}</span>
          </div>
        `).join('');
      }

      if (total === 0) {
        html += '<div class="empty-state" style="padding: 20px 0;">No commands in the last 24 hours</div>';
      }

      el.innerHTML = html;
    }

    function renderRiskBars(distribution, total) {
      const levels = ['safe', 'caution', 'dangerous', 'critical'];
      if (total === 0) {
        return '<div class="empty-state" style="padding: 10px 0;">No data</div>';
      }

      return levels.map(level => {
        const count = distribution[level] || 0;
        const pct = total > 0 ? (count / total * 100) : 0;
        return `
          <div class="risk-bar-container">
            <div class="risk-bar-label">
              <span>${level}</span>
              <span class="risk-bar-count">${count} (${pct.toFixed(0)}%)</span>
            </div>
            <div class="risk-bar-track">
              <div class="risk-bar-fill ${level}" style="width: ${pct}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    // --- Blocked Commands Log ---

    async function fetchBlockedCommands() {
      try {
        const response = await fetch('/api/security/blocked-commands?limit=25');
        const commands = await response.json();
        renderBlockedCommands(commands);
      } catch (error) {
        console.error('Failed to fetch blocked commands:', error);
      }
    }

    function renderBlockedCommands(commands) {
      const el = document.getElementById('blockedCommandsList');

      if (!commands || commands.length === 0) {
        el.innerHTML = '<div class="empty-state">No blocked commands</div>';
        return;
      }

      el.innerHTML = commands.map(cmd => `
        <div class="blocked-cmd-item">
          <div class="command-status blocked"></div>
          <div style="flex: 1; min-width: 0;">
            <div class="blocked-cmd-text">${escapeHtml(cmd.command)}</div>
            <div class="blocked-cmd-meta">
              <span class="risk-badge ${cmd.riskLevel}">${cmd.riskLevel} (${cmd.riskScore})</span>
              ${(cmd.violations || []).map(v => '<span class="blocked-cmd-violation">' + escapeHtml(v) + '</span>').join('')}
              <span>${formatTime(cmd.timestamp)}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --- Security Events Feed ---

    async function fetchSecurityEvents() {
      try {
        const [warnRes, errorRes] = await Promise.all([
          fetch('/api/events?level=warn&limit=25'),
          fetch('/api/events?level=error&limit=25')
        ]);
        const warns = await warnRes.json();
        const errors = await errorRes.json();

        // Merge and sort by timestamp desc
        const all = [...warns, ...errors].sort((a, b) =>
          new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
        ).slice(0, 50);

        renderSecurityEvents(all);
      } catch (error) {
        console.error('Failed to fetch security events:', error);
      }
    }

    function renderSecurityEvents(events) {
      const el = document.getElementById('securityEventsFeed');

      if (!events || events.length === 0) {
        el.innerHTML = '<div class="empty-state">No security events</div>';
        return;
      }

      el.innerHTML = events.map(evt => `
        <div class="event-feed-item">
          <span class="event-level-badge ${evt.level}">${evt.level}</span>
          <span class="event-feed-message">${escapeHtml(evt.message)}</span>
          <span class="event-feed-time">${formatTime(evt.timestamp)}</span>
        </div>
      `).join('');
    }

    // --- Egress Blocks ---

    async function fetchBlocked() {
      try {
        const response = await fetch('/api/blocked');
        const blocks = await response.json();
        renderEgressBlocks(blocks);
      } catch (error) {
        console.error('Failed to fetch blocks:', error);
      }
    }

    function renderEgressBlocks(blocks) {
      const tbody = document.getElementById('egressBlocksTable');

      if (!blocks || blocks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No pending blocks</td></tr>';
        return;
      }

      tbody.innerHTML = blocks.map(block => `
        <tr>
          <td><code>${escapeHtml(block.pattern?.name || 'Unknown')}</code></td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
            <code>${escapeHtml(block.redactedText)}</code>
          </td>
          <td>${block.connector || '-'}</td>
          <td>${formatTime(block.timestamp)}</td>
          <td>
            <button class="btn btn-small btn-primary" onclick="approveBlock('${block.id}')" style="margin-right: 8px;">Approve</button>
            <button class="btn btn-small btn-danger" onclick="denyBlock('${block.id}')">Deny</button>
          </td>
        </tr>
      `).join('');
    }

    async function approveBlock(id) {
      try {
        await fetch(`/api/blocked/${id}/approve`, { method: 'POST' });
        showToast('Block approved');
        fetchBlocked();
      } catch (error) {
        showToast('Failed to approve', 'error');
      }
    }

    async function denyBlock(id) {
      try {
        await fetch(`/api/blocked/${id}/deny`, { method: 'POST' });
        showToast('Block denied');
        fetchBlocked();
      } catch (error) {
        showToast('Failed to deny', 'error');
      }
    }

    async function fetchExposures() {
      try {
        const response = await fetch('/api/exposures?limit=50');
        const exposures = await response.json();
        renderExposures(exposures);
      } catch (error) {
        console.error('Failed to fetch exposures:', error);
      }
    }

    function renderExposures(exposures) {
      const tbody = document.getElementById('exposuresTable');

      if (!exposures || exposures.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No exposure scans</td></tr>';
        return;
      }

      tbody.innerHTML = exposures.map(exp => `
        <tr>
          <td><span class="risk-badge ${exp.severity === 'critical' ? 'critical' : exp.severity === 'high' ? 'dangerous' : exp.severity === 'medium' ? 'caution' : 'safe'}">${exp.severity}</span></td>
          <td>${exp.port}</td>
          <td><code>${exp.bindAddress}</code></td>
          <td>${exp.agent}</td>
          <td>${exp.hasAuth === true ? 'Yes' : exp.hasAuth === false ? 'No' : 'Unknown'}</td>
          <td>${exp.action}</td>
          <td style="max-width: 300px;">${escapeHtml(exp.message)}</td>
        </tr>
      `).join('');
    }

    // ─────────────────────────────────────────────────────────────
    // Bash Bro Tab Functions
    // ─────────────────────────────────────────────────────────────

    async function fetchBroStatus() {
      try {
        const response = await fetch('/api/bro/status');
        const status = await response.json();

        const statusDot = document.getElementById('broStatusDot');
        const modelInfo = document.getElementById('broModelInfo');

        if (status && status.ollamaAvailable) {
          statusDot.className = 'status-dot connected';
          modelInfo.textContent = `Connected - Model: ${status.ollamaModel}`;

          document.getElementById('broPlatform').textContent = status.platform || '-';
          document.getElementById('broShell').textContent = status.shell || '-';
          document.getElementById('broProjectType').textContent = status.projectType || 'Unknown';
        } else {
          statusDot.className = 'status-dot disconnected';
          modelInfo.textContent = 'Ollama not connected';

          document.getElementById('broPlatform').textContent = '-';
          document.getElementById('broShell').textContent = '-';
          document.getElementById('broProjectType').textContent = '-';
        }
      } catch (error) {
        console.error('Failed to fetch Bro status:', error);
      }
    }

    async function fetchBroModels() {
      try {
        const response = await fetch('/api/bro/models');
        const data = await response.json();

        const select = document.getElementById('modelSelect');

        if (data.available && data.models.length > 0) {
          select.innerHTML = data.models.map(model =>
            `<option value="${model}">${model}</option>`
          ).join('');
        } else {
          select.innerHTML = '<option value="">Ollama not available</option>';
        }
      } catch (error) {
        console.error('Failed to fetch models:', error);
      }
    }

    async function fetchBroEvents() {
      try {
        const response = await fetch('/api/bro/events?limit=50');
        const events = await response.json();
        renderBroEvents(events);

        // Count today's events
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayEvents = events.filter(e => new Date(e.timestamp) >= today);
        document.getElementById('broRequestsToday').textContent = todayEvents.length;
      } catch (error) {
        console.error('Failed to fetch Bro events:', error);
      }
    }

    function renderBroEvents(events) {
      const list = document.getElementById('broActivityLog');

      if (!events || events.length === 0) {
        list.innerHTML = '<li class="empty-state">No AI activity recorded</li>';
        return;
      }

      list.innerHTML = events.map(event => `
        <li class="activity-item">
          <div class="activity-icon ai">${getEventIcon(event.eventType)}</div>
          <div class="activity-content">
            <div class="activity-message">
              <strong>${formatEventType(event.eventType)}</strong><br>
              Input: ${escapeHtml(event.inputContext.slice(0, 100))}${event.inputContext.length > 100 ? '...' : ''}<br>
              ${event.success ? `Output: ${escapeHtml(event.outputSummary.slice(0, 100))}${event.outputSummary.length > 100 ? '...' : ''}` : '<span style="color:var(--red)">Failed</span>'}
            </div>
            <div class="activity-meta">
              <span>${event.modelUsed}</span>
              <span>${event.latencyMs}ms</span>
              <span>${event.latencyMs < 50 ? '<span class="model-tag quant">CACHED</span>' : ''}</span>
              <span>${formatTime(event.timestamp)}</span>
            </div>
          </div>
        </li>
      `).join('');
    }

    function getEventIcon(type) {
      const icons = {
        'suggestion': '?',
        'explanation': 'i',
        'fix': 'F',
        'script': 'S',
        'safety': '!'
      };
      return icons[type] || 'AI';
    }

    function formatEventType(type) {
      const names = {
        'suggestion': 'Command Suggestion',
        'explanation': 'Command Explanation',
        'fix': 'Error Fix',
        'script': 'Script Generation',
        'safety': 'Safety Analysis'
      };
      return names[type] || type;
    }

    async function changeModel() {
      const select = document.getElementById('modelSelect');
      const model = select.value;

      if (!model) {
        showToast('Select a model first', 'error');
        return;
      }

      try {
        const response = await fetch('/api/bro/model', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model })
        });

        if (response.ok) {
          showToast(`Model changed to ${model}`);
        } else {
          showToast('Failed to change model', 'error');
        }
      } catch (error) {
        showToast('Failed to change model', 'error');
      }
    }

    async function triggerScan() {
      try {
        const response = await fetch('/api/bro/scan', { method: 'POST' });

        if (response.ok) {
          showToast('System scan requested');
        } else {
          showToast('Failed to trigger scan', 'error');
        }
      } catch (error) {
        showToast('Failed to trigger scan', 'error');
      }
    }

    async function fetchRouterStats() {
      try {
        const response = await fetch('/api/bro/events?limit=200');
        const events = await response.json();

        let patternCount = 0;
        let aiCount = 0;

        // Simple heuristic: events with latency > 100ms were likely AI-routed
        const fastEvents = events.filter(e => e.latencyMs < 100);
        const slowEvents = events.filter(e => e.latencyMs >= 100);

        document.getElementById('routerPatternCount').textContent = fastEvents.length;
        document.getElementById('routerAiCount').textContent = slowEvents.length;

        if (events.length > 0) {
          const avgLatency = Math.round(events.reduce((sum, e) => sum + (e.latencyMs || 0), 0) / events.length);
          document.getElementById('routerAvgConfidence').textContent = avgLatency + 'ms avg';
        }
      } catch (error) {
        console.error('Failed to fetch router stats:', error);
      }
    }

    async function fetchAdapterEvents() {
      try {
        const response = await fetch('/api/bro/adapters/events');
        const events = await response.json();
        const tbody = document.getElementById('adapterEventsTable');

        if (!events || events.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No adapter events recorded</td></tr>';
          return;
        }

        tbody.innerHTML = events.map(e => `
          <tr>
            <td style="font-family:'JetBrains Mono',monospace; font-size:0.8rem;">${formatTime(e.timestamp)}</td>
            <td><strong>${escapeHtml(e.adapterName)}</strong></td>
            <td style="font-size:0.85rem;">${escapeHtml(e.baseModel)}</td>
            <td><span class="model-tag purpose">${escapeHtml(e.purpose)}</span></td>
            <td>${escapeHtml(e.action)}</td>
            <td>${e.success ? '<span style="color:var(--green);">OK</span>' : '<span style="color:var(--red);">FAIL</span>'}</td>
          </tr>
        `).join('');

        // Update active adapter count
        const activeCount = events.filter(e => e.action === 'activated' && e.success).length;
        document.getElementById('broAdaptersActive').textContent = activeCount;
      } catch (error) {
        console.error('Failed to fetch adapter events:', error);
      }
    }

    async function fetchBroProfileInfo() {
      try {
        const response = await fetch('/api/bro/profiles');
        const profiles = await response.json();

        if (profiles && profiles.length > 0) {
          document.getElementById('broActiveProfile').textContent = profiles[0].name;
        } else {
          document.getElementById('broActiveProfile').textContent = 'None';
        }
      } catch {
        document.getElementById('broActiveProfile').textContent = 'N/A';
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Settings Tab Functions
    // ─────────────────────────────────────────────────────────────

    const commandDescriptions = {
      // Allowed: File operations
      'ls *': 'List directory contents',
      'dir *': 'List directory contents (Windows)',
      'cat *': 'Display file contents',
      'head *': 'Show first lines of a file',
      'tail *': 'Show last lines of a file',
      'less *': 'Page through file contents',
      'more *': 'Page through file contents',
      'grep *': 'Search text with patterns',
      'find *': 'Find files and directories',
      'rg *': 'Ripgrep fast search',
      'fd *': 'Fast file finder',
      'mkdir *': 'Create directories',
      'touch *': 'Create empty files or update timestamps',
      'cp *': 'Copy files and directories',
      'mv *': 'Move or rename files',
      'rm *': 'Remove files (non-destructive patterns only)',
      'cd *': 'Change directory',
      'pwd': 'Print working directory',
      'echo *': 'Print text to stdout',
      'printf *': 'Format and print text',
      'which *': 'Locate a command on PATH',
      'where *': 'Locate a command on PATH (Windows)',
      'type *': 'Show command type or file contents',
      'tar *': 'Archive and extract tar files',
      'zip *': 'Create zip archives',
      'unzip *': 'Extract zip archives',
      'gzip *': 'Compress files with gzip',
      'gunzip *': 'Decompress gzip files',
      // Allowed: Text processing
      'sed *': 'Stream editor for text transformation',
      'awk *': 'Pattern scanning and processing',
      'sort *': 'Sort lines of text',
      'uniq *': 'Filter duplicate lines',
      'wc *': 'Count words, lines, and bytes',
      'diff *': 'Compare files line by line',
      'tr *': 'Translate or delete characters',
      // Allowed: Version control
      'git *': 'Git version control operations',
      'gh *': 'GitHub CLI operations',
      // Allowed: Package managers & runtimes
      'npm *': 'Node.js package manager',
      'npx *': 'Run Node.js packages',
      'pnpm *': 'Fast Node.js package manager',
      'yarn *': 'Yarn package manager',
      'bun *': 'Bun JavaScript runtime and package manager',
      'node *': 'Run Node.js scripts',
      'deno *': 'Deno JavaScript/TypeScript runtime',
      'tsx *': 'Run TypeScript files directly',
      'ts-node *': 'TypeScript execution for Node.js',
      'python *': 'Run Python scripts',
      'python3 *': 'Run Python 3 scripts',
      'pip *': 'Python package installer',
      'pip3 *': 'Python 3 package installer',
      'uv *': 'Fast Python package installer',
      'pipx *': 'Install and run Python CLI tools',
      'cargo *': 'Rust package manager and build tool',
      'rustc *': 'Rust compiler',
      'rustup *': 'Rust toolchain manager',
      'go *': 'Go language tools',
      // Allowed: Build tools
      'tsc *': 'TypeScript compiler',
      'esbuild *': 'Fast JavaScript bundler',
      'vite *': 'Frontend build tool',
      'webpack *': 'JavaScript module bundler',
      'rollup *': 'JavaScript module bundler',
      'tsup *': 'TypeScript library bundler',
      'make *': 'Build automation tool',
      'cmake *': 'Cross-platform build system',
      // Allowed: Testing & linting
      'jest *': 'JavaScript testing framework',
      'vitest *': 'Vite-native test framework',
      'pytest *': 'Python testing framework',
      'mocha *': 'JavaScript test framework',
      'eslint *': 'JavaScript/TypeScript linter',
      'prettier *': 'Code formatter',
      'biome *': 'Fast linter and formatter',
      'ruff *': 'Fast Python linter',
      'black *': 'Python code formatter',
      // Allowed: AI & security tools
      'claude *': 'Claude Code CLI',
      'aider *': 'AI pair programming tool',
      'bashbros *': 'BashBros security tool',
      // Allowed: Editors
      'code *': 'Visual Studio Code',
      'cursor *': 'Cursor AI editor',
      'vim *': 'Vim text editor',
      'nvim *': 'Neovim text editor',
      'nano *': 'Nano text editor',
      'emacs *': 'Emacs text editor',
      // Allowed: Docker
      'docker *': 'Docker container operations',
      'docker-compose *': 'Docker Compose multi-container orchestration',
      'podman *': 'Podman container operations',
      // Allowed: Network
      'curl *': 'Transfer data from URLs',
      'wget *': 'Download files from the web',
      'ping *': 'Test network connectivity',
      'ssh *': 'Secure shell remote connection',
      // Allowed: System info
      'env': 'Show environment variables',
      'env *': 'Show or set environment variables',
      'printenv *': 'Print environment variables',
      'whoami': 'Show current username',
      'hostname': 'Show system hostname',
      'uname *': 'Show system information',
      'date': 'Show current date and time',
      'uptime': 'Show system uptime',
      'ps *': 'List running processes',
      'top': 'Monitor system processes',
      'htop': 'Interactive process viewer',
      'btop': 'Resource monitor',
      '*': 'Wildcard \u2014 matches all commands',
      // Blocked: Destructive rm
      'rm * /': 'Delete entire root filesystem',
      'rm * ~': 'Delete entire home directory',
      'rm * /*': 'Delete all top-level directories',
      'rm * /home*': 'Delete all user home directories',
      'rm * /etc*': 'Delete system configuration files',
      'rm * /usr*': 'Delete system programs and libraries',
      'rm * /var*': 'Delete system logs and variable data',
      'rm * /bin*': 'Delete essential system binaries',
      'rm * /sbin*': 'Delete system admin binaries',
      'rm * /lib*': 'Delete shared libraries',
      'rm * /boot*': 'Delete boot loader files',
      'rm * /opt*': 'Delete optional software packages',
      'rm * /root*': 'Delete root user home directory',
      'rm * /srv*': 'Delete server data files',
      'rm * /mnt*': 'Delete mounted filesystem data',
      'rm * /media*': 'Delete removable media mount points',
      // Blocked: Windows destructive
      'rm * C:\\*': 'Delete entire Windows C: drive',
      'rm * C:/*': 'Delete entire Windows C: drive',
      'Remove-Item * C:\\*': 'PowerShell delete entire C: drive',
      'Remove-Item * C:/*': 'PowerShell delete entire C: drive',
      'rd /s *': 'Windows recursive directory delete',
      'rmdir /s *': 'Windows recursive directory delete',
      // Blocked: Fork bomb
      ':(){:|:&};:': 'Fork bomb \u2014 crashes the system by spawning infinite processes',
      ':(){ :|:& };:': 'Fork bomb \u2014 crashes the system by spawning infinite processes',
      // Blocked: Disk destruction
      'mkfs*': 'Format a disk \u2014 destroys all data on the device',
      'dd if=/dev/zero*': 'Overwrite a device with zeros',
      'dd of=/dev/*': 'Write raw data to a device',
      '> /dev/sda*': 'Overwrite a SATA/SSD disk device',
      '> /dev/nvme*': 'Overwrite an NVMe disk device',
      '> /dev/hd*': 'Overwrite a hard disk device',
      // Blocked: Dangerous permissions
      'chmod -R 777 /*': 'Make all system files world-writable',
      'chmod -R 777 /': 'Make entire filesystem world-writable',
      'chmod * 777 /*': 'Make system files world-writable',
      'chown -R * /*': 'Change ownership of all system files',
      // Blocked: Pipe to shell
      'curl * | bash*': 'Download and execute remote script',
      'curl * | sh*': 'Download and execute remote script',
      'wget * | bash*': 'Download and execute remote script',
      'wget * | sh*': 'Download and execute remote script',
      'curl * | sudo*': 'Download and execute remote script as root',
      'wget * | sudo*': 'Download and execute remote script as root',
      // Blocked: History/log destruction
      'history -c*': 'Clear shell history \u2014 hides activity',
      'shred *': 'Securely overwrite files to prevent recovery',
      // Blocked: Dangerous redirects
      '> /etc/passwd*': 'Overwrite system user database',
      '> /etc/shadow*': 'Overwrite system password hashes',
    };

    function getCommandDescription(pattern) {
      return commandDescriptions[pattern] || '';
    }

    function getListItems(type) {
      if (type === 'allow') return config.commands?.allow;
      if (type === 'block') return config.commands?.block;
      if (type === 'pathAllow') return config.paths?.allow;
      if (type === 'pathBlock') return config.paths?.block;
      return null;
    }

    function renderList(type) {
      const listEl = document.getElementById(type + 'List');
      const items = getListItems(type);

      if (!items || items.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No items</div>';
        return;
      }

      const isPath = type.startsWith('path');
      listEl.innerHTML = items.map((item, idx) => {
        const desc = isPath ? '' : getCommandDescription(item);
        return `
          <div class="list-item">
            <div class="list-item-text">
              ${escapeHtml(item)}${desc ? `<div class="list-item-desc">${escapeHtml(desc)}</div>` : ''}
            </div>
            <button class="list-item-remove" onclick="removeFromList('${type}', ${idx})">x</button>
          </div>
        `;
      }).join('');
    }

    function addToList(type) {
      const input = document.getElementById(type + 'Input');
      const value = input.value.trim();
      if (!value) return;

      if (type === 'allow') {
        if (!config.commands) config.commands = { allow: [], block: [] };
        if (!config.commands.allow) config.commands.allow = [];
        config.commands.allow.push(value);
      } else if (type === 'block') {
        if (!config.commands) config.commands = { allow: [], block: [] };
        if (!config.commands.block) config.commands.block = [];
        config.commands.block.push(value);
      } else if (type === 'pathAllow') {
        if (!config.paths) config.paths = { allow: [], block: [] };
        if (!config.paths.allow) config.paths.allow = [];
        config.paths.allow.push(value);
      } else if (type === 'pathBlock') {
        if (!config.paths) config.paths = { allow: [], block: [] };
        if (!config.paths.block) config.paths.block = [];
        config.paths.block.push(value);
      }

      input.value = '';
      renderList(type);
    }

    function removeFromList(type, idx) {
      if (type === 'allow') {
        config.commands.allow.splice(idx, 1);
      } else if (type === 'block') {
        config.commands.block.splice(idx, 1);
      } else if (type === 'pathAllow') {
        config.paths.allow.splice(idx, 1);
      } else if (type === 'pathBlock') {
        config.paths.block.splice(idx, 1);
      }
      renderList(type);
    }

    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          config = await response.json();
          updateSettingsUI();
        } else {
          showToast('Failed to load config', 'error');
        }
      } catch (error) {
        console.error('Failed to load config:', error);
        showToast('Failed to load config', 'error');
      }
    }

    async function saveConfig() {
      config.profile = document.getElementById('profileSelect').value;
      config.secrets = config.secrets || {};
      config.secrets.enabled = document.getElementById('secretsEnabled').checked;
      config.audit = config.audit || {};
      config.audit.enabled = document.getElementById('auditEnabled').checked;
      config.rateLimit = config.rateLimit || {};
      config.rateLimit.enabled = document.getElementById('rateLimitEnabled').checked;
      config.riskScoring = config.riskScoring || {};
      config.riskScoring.enabled = document.getElementById('riskScoringEnabled').checked;
      config.loopDetection = config.loopDetection || {};
      config.loopDetection.enabled = document.getElementById('loopDetectionEnabled').checked;
      config.anomalyDetection = config.anomalyDetection || {};
      config.anomalyDetection.enabled = document.getElementById('anomalyDetectionEnabled').checked;
      config.outputScanning = config.outputScanning || {};
      config.outputScanning.enabled = document.getElementById('outputScanningEnabled').checked;
      config.undo = config.undo || {};
      config.undo.enabled = document.getElementById('undoEnabled').checked;
      config.ward = config.ward || {};
      config.ward.enabled = document.getElementById('wardEnabled').checked;

      // Collect all advanced config inputs
      const whStart = document.querySelector('[data-config-path="anomalyDetection.workingHours.0"]');
      const whEnd = document.querySelector('[data-config-path="anomalyDetection.workingHours.1"]');
      if (whStart && whEnd) {
        if (!config.anomalyDetection) config.anomalyDetection = {};
        config.anomalyDetection.workingHours = [Number(whStart.value), Number(whEnd.value)];
      }

      document.querySelectorAll('[data-config-path]').forEach(el => {
        const path = el.dataset.configPath;
        // Skip workingHours sub-fields (handled above)
        if (path.startsWith('anomalyDetection.workingHours.')) return;

        const parts = path.split('.');
        let target = config;
        for (let i = 0; i < parts.length - 1; i++) {
          if (!target[parts[i]]) target[parts[i]] = {};
          target = target[parts[i]];
        }
        const key = parts[parts.length - 1];
        if (el.type === 'checkbox') {
          target[key] = el.checked;
        } else if (el.type === 'number') {
          target[key] = el.value !== '' ? Number(el.value) : undefined;
        } else {
          target[key] = el.value;
        }
      });

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (response.ok) {
          showToast('Configuration saved!', 'success');
        } else {
          showToast('Failed to save config', 'error');
        }
      } catch (error) {
        console.error('Failed to save config:', error);
        showToast('Failed to save config', 'error');
      }
    }

    function updateSettingsUI() {
      if (!config) return;

      document.getElementById('profileSelect').value = config.profile || 'permissive';

      document.getElementById('secretsEnabled').checked = config.secrets?.enabled !== false;
      document.getElementById('auditEnabled').checked = config.audit?.enabled !== false;
      document.getElementById('rateLimitEnabled').checked = config.rateLimit?.enabled !== false;
      document.getElementById('riskScoringEnabled').checked = config.riskScoring?.enabled !== false;
      document.getElementById('loopDetectionEnabled').checked = config.loopDetection?.enabled !== false;
      document.getElementById('anomalyDetectionEnabled').checked = config.anomalyDetection?.enabled !== false;
      document.getElementById('outputScanningEnabled').checked = config.outputScanning?.enabled !== false;
      document.getElementById('undoEnabled').checked = config.undo?.enabled !== false;
      document.getElementById('wardEnabled').checked = config.ward?.enabled !== false;

      renderList('allow');
      renderList('block');
      renderList('pathAllow');
      renderList('pathBlock');
      renderAdvancedConfig();
    }

    // ─────────────────────────────────────────────────────────────
    // Agent Integration Status
    // ─────────────────────────────────────────────────────────────

    async function loadAgentStatus() {
      try {
        const response = await fetch('/api/agents/status');
        if (!response.ok) return;
        const data = await response.json();
        renderAgentStatus(data.agents);
      } catch (error) {
        console.error('Failed to load agent status:', error);
      }
    }

    function renderAgentStatus(agents) {
      const container = document.getElementById('agentGrid');
      if (!agents || agents.length === 0) {
        container.innerHTML = '<span style="color:var(--grey-500); font-size:0.85rem;">No agent data</span>';
        return;
      }

      container.innerHTML = agents.map(agent => {
        const isActive = agent.installed && agent.hooksInstalled;
        const isDetected = agent.installed && !agent.hooksInstalled;
        const dotClass = isActive ? 'active' : isDetected ? 'detected' : 'not-found';

        // Build tooltip with hook details
        const tipParts = [];
        if (isActive) tipParts.push('Hooks installed');
        else if (isDetected) tipParts.push('Installed, hooks not configured');
        else tipParts.push('Not installed');
        if (agent.hooks && agent.hooks.length > 0) tipParts.push(agent.hooks.join(', '));
        if (agent.extra?.allToolsRecording) tipParts.push('All-tools recording ON');
        if (agent.extra?.gatewayRunning !== undefined) tipParts.push('Gateway: ' + (agent.extra.gatewayRunning ? 'Running' : 'Stopped'));
        if (agent.extra?.sandboxMode) tipParts.push('Sandbox: ' + agent.extra.sandboxMode);

        const hookCount = agent.hooks ? agent.hooks.length : 0;
        const detail = isActive && hookCount > 0 ? `<span class="agent-chip-detail">${hookCount} hooks</span>` : '';

        return `<div class="agent-chip ${isActive ? 'integrated' : ''}" title="${escapeHtml(tipParts.join('\n'))}">
          <span class="agent-chip-dot ${dotClass}"></span>
          ${escapeHtml(agent.name)}${detail}
        </div>`;
      }).join('');
    }

    // ─────────────────────────────────────────────────────────────
    // Advanced Configuration Display
    // ─────────────────────────────────────────────────────────────

    function renderAdvancedConfig() {
      const container = document.getElementById('advancedConfigBody');
      if (!config) {
        container.innerHTML = '<div class="empty-state">No config loaded</div>';
        return;
      }

      let html = '';

      // General (read-only display)
      html += configSection('General', [
        configRowStatic('Agent', config.agent || 'claude-code'),
        configRowStatic('Profile', config.profile || 'permissive'),
        configRowStatic('Dashboard Port', config.dashboard?.port ?? 17800),
        configRowStatic('Dashboard Bind', config.dashboard?.bind || '127.0.0.1'),
      ]);

      // Rate Limits
      if (config.rateLimit) {
        html += configSection('Rate Limits', [
          configRowNumber('Max / minute', 'rateLimit.maxPerMinute', config.rateLimit.maxPerMinute, 1, 10000, 1),
          configRowNumber('Max / hour', 'rateLimit.maxPerHour', config.rateLimit.maxPerHour, 1, 100000, 1),
        ]);
      }

      // Risk Scoring
      if (config.riskScoring) {
        html += configSection('Risk Scoring', [
          configRowNumber('Warn threshold', 'riskScoring.warnThreshold', config.riskScoring.warnThreshold, 1, 10, 1),
          configRowNumber('Block threshold', 'riskScoring.blockThreshold', config.riskScoring.blockThreshold, 1, 10, 1),
        ]);
      }

      // Loop Detection
      if (config.loopDetection) {
        html += configSection('Loop Detection', [
          configRowNumber('Max repeats', 'loopDetection.maxRepeats', config.loopDetection.maxRepeats, 1, 100, 1),
          configRowNumber('Max turns', 'loopDetection.maxTurns', config.loopDetection.maxTurns, 10, 10000, 1),
          configRowNumber('Similarity', 'loopDetection.similarityThreshold', config.loopDetection.similarityThreshold, 0, 1, 0.05),
          configRowNumber('Cooldown (ms)', 'loopDetection.cooldownMs', config.loopDetection.cooldownMs, 0, 60000, 100),
          configRowNumber('Window size', 'loopDetection.windowSize', config.loopDetection.windowSize, 1, 1000, 1),
          configRowSelect('Action', 'loopDetection.action', config.loopDetection.action, ['warn', 'block']),
        ]);
      }

      // Anomaly Detection
      if (config.anomalyDetection) {
        const wh = config.anomalyDetection.workingHours || [9, 17];
        html += configSection('Anomaly Detection', [
          configRowWorkingHours(wh[0], wh[1]),
          configRowNumber('Commands / min', 'anomalyDetection.typicalCommandsPerMinute', config.anomalyDetection.typicalCommandsPerMinute, 1, 1000, 1),
          configRowNumber('Learning cmds', 'anomalyDetection.learningCommands', config.anomalyDetection.learningCommands, 1, 10000, 1),
          configRowSelect('Action', 'anomalyDetection.action', config.anomalyDetection.action, ['warn', 'block']),
        ]);
      }

      // Output Scanning
      if (config.outputScanning) {
        html += configSection('Output Scanning', [
          configRowCheckbox('Scan for secrets', 'outputScanning.scanForSecrets', config.outputScanning.scanForSecrets !== false),
          configRowCheckbox('Scan for errors', 'outputScanning.scanForErrors', config.outputScanning.scanForErrors !== false),
          configRowNumber('Max output length', 'outputScanning.maxOutputLength', config.outputScanning.maxOutputLength, 100, 1000000, 100),
        ]);
      }

      // Undo Stack
      if (config.undo) {
        html += configSection('Undo Stack', [
          configRowNumber('Max stack size', 'undo.maxStackSize', config.undo.maxStackSize, 1, 1000, 1),
          configRowNumber('Max file size (bytes)', 'undo.maxFileSize', config.undo.maxFileSize, 1024, 104857600, 1024),
          configRowNumber('TTL (minutes)', 'undo.ttlMinutes', config.undo.ttlMinutes, 1, 10080, 1),
        ]);
      }

      // Secrets Guard
      if (config.secrets) {
        html += configSection('Secrets Guard', [
          configRowSelect('Mode', 'secrets.mode', config.secrets.mode || 'block', ['block', 'audit']),
        ]);
      }

      // Audit Log
      if (config.audit) {
        html += configSection('Audit Log', [
          configRowSelect('Destination', 'audit.destination', config.audit.destination || 'local', ['local', 'remote', 'both']),
        ]);
      }

      // Ward Security
      if (config.ward) {
        const wardRows = [];
        if (config.ward.exposure) {
          wardRows.push(configRowNumber('Scan interval', 'ward.exposure.scanInterval', config.ward.exposure.scanInterval, 1, 86400, 1));
          wardRows.push(configRowCheckbox('External probe', 'ward.exposure.externalProbe', config.ward.exposure.externalProbe !== false));
          const severityActions = config.ward.exposure.severityActions || {};
          wardRows.push(configRowSelect('Low severity', 'ward.exposure.severityActions.low', severityActions.low || 'alert', ['alert', 'block', 'block_and_kill']));
          wardRows.push(configRowSelect('Medium severity', 'ward.exposure.severityActions.medium', severityActions.medium || 'alert', ['alert', 'block', 'block_and_kill']));
          wardRows.push(configRowSelect('High severity', 'ward.exposure.severityActions.high', severityActions.high || 'block', ['alert', 'block', 'block_and_kill']));
          wardRows.push(configRowSelect('Critical severity', 'ward.exposure.severityActions.critical', severityActions.critical || 'block_and_kill', ['alert', 'block', 'block_and_kill']));
        }
        if (config.ward.egress) {
          wardRows.push(configRowSelect('Egress default', 'ward.egress.defaultAction', config.ward.egress.defaultAction || 'block', ['block', 'alert', 'log']));
        }
        if (wardRows.length > 0) {
          html += configSection('Ward Security', wardRows);
        }
      }

      container.innerHTML = html ? '<div class="config-grid">' + html + '</div>' : '<div class="empty-state">No advanced settings found</div>';
    }

    function configSection(title, rows) {
      return `<div class="config-section"><div class="config-section-title">${escapeHtml(title)}</div>${rows.join('')}</div>`;
    }

    function configRowStatic(key, value) {
      return `<div class="config-row"><span class="config-key">${escapeHtml(key)}</span><span class="config-value">${escapeHtml(String(value))}</span></div>`;
    }

    function configRowNumber(label, path, value, min, max, step) {
      const v = value ?? '';
      return `<div class="config-row"><span class="config-key">${escapeHtml(label)}</span><input type="number" class="config-input" data-config-path="${escapeHtml(path)}" value="${v}" min="${min}" max="${max}" step="${step}"></div>`;
    }

    function configRowSelect(label, path, value, options) {
      const opts = options.map(o => `<option value="${escapeHtml(o)}"${o === value ? ' selected' : ''}>${escapeHtml(o)}</option>`).join('');
      return `<div class="config-row"><span class="config-key">${escapeHtml(label)}</span><select class="config-select" data-config-path="${escapeHtml(path)}">${opts}</select></div>`;
    }

    function configRowCheckbox(label, path, checked) {
      return `<div class="config-row"><span class="config-key">${escapeHtml(label)}</span><input type="checkbox" class="config-checkbox" data-config-path="${escapeHtml(path)}"${checked ? ' checked' : ''}></div>`;
    }

    function configRowWorkingHours(startHour, endHour) {
      return `<div class="config-row"><span class="config-key">Working hours</span><div class="config-inline-group"><input type="number" class="config-input" data-config-path="anomalyDetection.workingHours.0" value="${startHour}" min="0" max="23" step="1"><span>to</span><input type="number" class="config-input" data-config-path="anomalyDetection.workingHours.1" value="${endHour}" min="0" max="23" step="1"></div></div>`;
    }

    function configRowPathList(label, configKey) {
      const parts = configKey.split('.');
      let items = config;
      for (const p of parts) {
        items = items?.[p];
      }
      if (!Array.isArray(items)) items = [];
      const listId = 'pathList_' + configKey.replace(/\./g, '_');
      const inputId = 'pathInput_' + configKey.replace(/\./g, '_');
      let html = `<div class="config-row" style="flex-direction:column;align-items:stretch;gap:4px"><span class="config-key">${escapeHtml(label)}</span>`;
      html += `<div class="config-path-list" id="${listId}">`;
      if (items.length === 0) {
        html += '<div style="padding:6px 8px;color:var(--grey-500);font-size:0.78rem;">No items</div>';
      } else {
        html += items.map((item, idx) => `<div class="config-path-item"><span>${escapeHtml(String(item))}</span><button class="config-path-remove" onclick="removeFromPathList('${escapeHtml(configKey)}', ${idx})">x</button></div>`).join('');
      }
      html += '</div>';
      html += `<div class="config-path-add"><input type="text" id="${inputId}" placeholder="Add path pattern"><button onclick="addToPathList('${escapeHtml(configKey)}')">Add</button></div>`;
      html += '</div>';
      return html;
    }

    function addToPathList(configKey) {
      const inputId = 'pathInput_' + configKey.replace(/\./g, '_');
      const input = document.getElementById(inputId);
      const value = input.value.trim();
      if (!value) return;

      const parts = configKey.split('.');
      let target = config;
      for (let i = 0; i < parts.length - 1; i++) {
        if (!target[parts[i]]) target[parts[i]] = {};
        target = target[parts[i]];
      }
      const key = parts[parts.length - 1];
      if (!Array.isArray(target[key])) target[key] = [];
      target[key].push(value);
      input.value = '';
      renderAdvancedConfig();
    }

    function removeFromPathList(configKey, idx) {
      const parts = configKey.split('.');
      let target = config;
      for (let i = 0; i < parts.length - 1; i++) {
        target = target?.[parts[i]];
      }
      const key = parts[parts.length - 1];
      if (Array.isArray(target?.[key])) {
        target[key].splice(idx, 1);
      }
      renderAdvancedConfig();
    }

    // ─────────────────────────────────────────────────────────────
    // Utility Functions
    // ─────────────────────────────────────────────────────────────

    function formatTime(ts) {
      if (!ts) return '-';
      return new Date(ts).toLocaleTimeString();
    }

    function formatDateTime(ts) {
      if (!ts) return '-';
      return new Date(ts).toLocaleString();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ─────────────────────────────────────────────────────────────
    // Models Tab Functions
    // ─────────────────────────────────────────────────────────────

    function formatBytes(bytes) {
      if (!bytes || bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    async function fetchInstalledModels() {
      try {
        const response = await fetch('/api/bro/models');
        const data = await response.json();
        const grid = document.getElementById('installedModelsGrid');

        if (!data.available || !data.models || data.models.length === 0) {
          grid.innerHTML = '<div class="empty-state">No models installed or Ollama not available</div>';
          return;
        }

        // Fetch details for each model
        const cards = await Promise.all(data.models.map(async (modelName) => {
          try {
            const detailRes = await fetch(`/api/bro/models/${encodeURIComponent(modelName)}`);
            if (!detailRes.ok) return createBasicModelCard(modelName);
            const details = await detailRes.json();
            return createDetailedModelCard(modelName, details);
          } catch {
            return createBasicModelCard(modelName);
          }
        }));

        grid.innerHTML = cards.join('');
      } catch (error) {
        console.error('Failed to fetch installed models:', error);
        document.getElementById('installedModelsGrid').innerHTML = '<div class="empty-state">Failed to load models</div>';
      }
    }

    function createBasicModelCard(name) {
      return `
        <div class="model-card">
          <div class="model-card-name">${escapeHtml(name)}</div>
          <div class="model-card-meta"><span>Details unavailable</span></div>
          <div class="model-card-actions">
            <button class="btn btn-danger btn-small" onclick="deleteModel('${escapeHtml(name)}')">Delete</button>
          </div>
        </div>
      `;
    }

    function createDetailedModelCard(name, details) {
      const d = details.details || {};
      return `
        <div class="model-card">
          <div class="model-card-name">${escapeHtml(name)}</div>
          <div class="model-card-meta">
            <span>${d.parameter_size || 'Unknown'} params</span>
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
              ${d.family ? `<span class="model-tag family">${escapeHtml(d.family)}</span>` : ''}
              ${d.quantization_level ? `<span class="model-tag quant">${escapeHtml(d.quantization_level)}</span>` : ''}
              ${d.format ? `<span class="model-tag size">${escapeHtml(d.format)}</span>` : ''}
            </div>
          </div>
          <div class="model-card-actions">
            <button class="btn btn-danger btn-small" onclick="deleteModel('${escapeHtml(name)}')">Delete</button>
          </div>
        </div>
      `;
    }

    async function fetchRunningModels() {
      try {
        const response = await fetch('/api/bro/models/running');
        const data = await response.json();
        const container = document.getElementById('runningModelsContainer');

        if (!data.models || data.models.length === 0) {
          container.innerHTML = '<div class="empty-state">No models currently loaded in memory</div>';
          return;
        }

        container.innerHTML = data.models.map(m => {
          const vramPct = m.size > 0 ? Math.round((m.size_vram / m.size) * 100) : 0;
          return `
            <div class="running-model-bar">
              <div style="min-width:200px;">
                <strong style="font-family:'JetBrains Mono',monospace;">${escapeHtml(m.name)}</strong><br>
                <span style="font-size:0.8rem; color:var(--grey-600);">
                  ${m.details ? `${m.details.parameter_size || ''} ${m.details.quantization_level || ''}` : ''}
                </span>
              </div>
              <div class="vram-bar-track">
                <div class="vram-bar-fill" style="width:${vramPct}%;"></div>
              </div>
              <div class="vram-label">
                VRAM: ${formatBytes(m.size_vram)} / ${formatBytes(m.size)} (${vramPct}%)
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to fetch running models:', error);
        document.getElementById('runningModelsContainer').innerHTML = '<div class="empty-state">Failed to load running models</div>';
      }
    }

    async function pullModel() {
      const input = document.getElementById('pullModelInput');
      const name = input.value.trim();
      if (!name) {
        showToast('Enter a model name', 'error');
        return;
      }

      const statusDiv = document.getElementById('pullStatus');
      const statusText = document.getElementById('pullStatusText');
      const progressBar = document.getElementById('pullProgressBar');

      statusDiv.style.display = 'block';
      statusText.textContent = `Pulling ${name}...`;
      progressBar.style.width = '10%';

      try {
        const response = await fetch('/api/bro/models/pull', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });

        if (response.ok) {
          statusText.textContent = `Successfully pulled ${name}`;
          progressBar.style.width = '100%';
          showToast(`Model ${name} pulled successfully`);
          input.value = '';
          fetchInstalledModels();
          fetchRunningModels();
        } else {
          statusText.textContent = `Failed to pull ${name}`;
          progressBar.style.width = '0%';
          showToast('Failed to pull model', 'error');
        }
      } catch (error) {
        statusText.textContent = `Error pulling ${name}`;
        progressBar.style.width = '0%';
        showToast('Failed to pull model', 'error');
      }
    }

    async function deleteModel(name) {
      if (!confirm(`Delete model "${name}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/bro/models/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (response.ok) {
          showToast(`Model ${name} deleted`);
          fetchInstalledModels();
          fetchRunningModels();
        } else {
          showToast('Failed to delete model', 'error');
        }
      } catch (error) {
        showToast('Failed to delete model', 'error');
      }
    }

    async function fetchAdapters() {
      try {
        const response = await fetch('/api/bro/adapters');
        const adapters = await response.json();
        const grid = document.getElementById('adaptersGrid');

        if (!adapters || adapters.length === 0) {
          grid.innerHTML = '<div class="empty-state">No adapters found in ~/.bashgym/integration/models/adapters/</div>';
          return;
        }

        grid.innerHTML = adapters.map(a => `
          <div class="model-card">
            <div class="model-card-name">${escapeHtml(a.name)}</div>
            <div class="model-card-meta">
              <span>Base: ${escapeHtml(a.baseModel)}</span>
              <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                <span class="model-tag purpose">${escapeHtml(a.purpose)}</span>
                <span class="model-tag score">Score: ${a.qualityScore}</span>
              </div>
              <span>Traces: ${a.tracesUsed} | Trained: ${a.trainedAt ? new Date(a.trainedAt).toLocaleDateString() : 'Unknown'}</span>
            </div>
            <div class="model-card-actions">
              <button class="btn btn-primary btn-small" onclick="activateAdapter('${escapeHtml(a.name)}')">Activate</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to fetch adapters:', error);
        document.getElementById('adaptersGrid').innerHTML = '<div class="empty-state">Failed to load adapters</div>';
      }
    }

    async function activateAdapter(name) {
      try {
        const response = await fetch(`/api/bro/adapters/${encodeURIComponent(name)}/activate`, { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
          showToast(`Adapter ${name} activated as ${data.ollamaModel}`);
          fetchAdapters();
          fetchInstalledModels();
        } else {
          showToast(data.error || 'Failed to activate adapter', 'error');
        }
      } catch (error) {
        showToast('Failed to activate adapter', 'error');
      }
    }

    async function fetchProfiles() {
      try {
        const response = await fetch('/api/bro/profiles');
        const profiles = await response.json();
        const container = document.getElementById('profilesList');

        if (!profiles || profiles.length === 0) {
          container.innerHTML = '<div class="empty-state">No profiles saved</div>';
          return;
        }

        container.innerHTML = profiles.map(p => {
          const adapterTags = Object.entries(p.adapters || {}).map(([purpose, adapter]) =>
            `<span class="model-tag purpose">${escapeHtml(purpose)}: ${escapeHtml(String(adapter))}</span>`
          ).join('');

          return `
            <div class="profile-item">
              <div>
                <div class="profile-item-name">${escapeHtml(p.name)}</div>
                <div class="profile-item-base">Base: ${escapeHtml(p.baseModel)}</div>
                <div class="profile-item-adapters" style="margin-top:6px;">${adapterTags || '<span style="color:var(--grey-500); font-size:0.8rem;">No adapters assigned</span>'}</div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn btn-small" onclick="loadProfileIntoEditor('${escapeHtml(p.name)}')">Edit</button>
                <button class="btn btn-danger btn-small" onclick="deleteProfile('${escapeHtml(p.name)}')">Delete</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to fetch profiles:', error);
        document.getElementById('profilesList').innerHTML = '<div class="empty-state">Failed to load profiles</div>';
      }
    }

    async function saveProfile() {
      const name = document.getElementById('profileName').value.trim();
      const baseModel = document.getElementById('profileBaseModel').value.trim();

      if (!name || !baseModel) {
        showToast('Profile name and base model are required', 'error');
        return;
      }

      const adapters = {};
      const purposes = ['suggest', 'safety', 'route', 'explain', 'fix', 'script'];
      for (const purpose of purposes) {
        const val = document.getElementById(`profileAdapter${purpose.charAt(0).toUpperCase() + purpose.slice(1)}`).value.trim();
        if (val) adapters[purpose] = val;
      }

      try {
        const response = await fetch('/api/bro/profiles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, baseModel, adapters })
        });

        if (response.ok) {
          showToast(`Profile "${name}" saved`);
          fetchProfiles();
          // Clear form
          document.getElementById('profileName').value = '';
          document.getElementById('profileBaseModel').value = '';
          purposes.forEach(p => document.getElementById(`profileAdapter${p.charAt(0).toUpperCase() + p.slice(1)}`).value = '');
        } else {
          showToast('Failed to save profile', 'error');
        }
      } catch (error) {
        showToast('Failed to save profile', 'error');
      }
    }

    function loadProfileIntoEditor(name) {
      fetch(`/api/bro/profiles`).then(r => r.json()).then(profiles => {
        const profile = profiles.find(p => p.name === name);
        if (!profile) return;

        document.getElementById('profileName').value = profile.name;
        document.getElementById('profileBaseModel').value = profile.baseModel;

        const purposes = ['suggest', 'safety', 'route', 'explain', 'fix', 'script'];
        purposes.forEach(p => {
          const el = document.getElementById(`profileAdapter${p.charAt(0).toUpperCase() + p.slice(1)}`);
          el.value = (profile.adapters && profile.adapters[p]) || '';
        });
      });
    }

    async function deleteProfile(name) {
      if (!confirm(`Delete profile "${name}"?`)) return;

      try {
        const response = await fetch(`/api/bro/profiles/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (response.ok) {
          showToast(`Profile "${name}" deleted`);
          fetchProfiles();
        } else {
          showToast('Failed to delete profile', 'error');
        }
      } catch (error) {
        showToast('Failed to delete profile', 'error');
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Context Tab Functions
    // ─────────────────────────────────────────────────────────────

    async function fetchContextIndex() {
      try {
        const response = await fetch('/api/context/index');
        const index = await response.json();

        document.getElementById('ctxLastUpdated').textContent = index.lastUpdated ? new Date(index.lastUpdated).toLocaleString() : 'Never';
        document.getElementById('ctxAgents').textContent = index.agents ? index.agents.length : 0;
        document.getElementById('ctxSessions').textContent = index.sessionCount || 0;
        document.getElementById('ctxCommands').textContent = index.commandFileCount || 0;
        document.getElementById('ctxErrors').textContent = index.errorFileCount || 0;
      } catch (error) {
        console.error('Failed to fetch context index:', error);
      }
    }

    async function fetchContextMemory() {
      try {
        const response = await fetch('/api/context/memory');
        const memoryFiles = await response.json();
        const container = document.getElementById('memoryFilesContainer');

        const entries = Object.entries(memoryFiles);
        if (entries.length === 0) {
          container.innerHTML = '<div class="empty-state">No memory files found. Initialize the context store to create starter files.</div>';
          return;
        }

        container.innerHTML = entries.map(([name, content]) => `
          <div class="memory-file-section">
            <div class="memory-file-header">
              <span>${escapeHtml(name)}.md</span>
              <button class="btn btn-primary btn-small" onclick="saveMemoryFile('${escapeHtml(name)}')">Save</button>
            </div>
            <textarea class="memory-file-editor" id="memoryEditor_${escapeHtml(name)}">${escapeHtml(content || '')}</textarea>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to fetch memory files:', error);
        document.getElementById('memoryFilesContainer').innerHTML = '<div class="empty-state">Failed to load memory files</div>';
      }
    }

    async function saveMemoryFile(name) {
      const textarea = document.getElementById(`memoryEditor_${name}`);
      if (!textarea) return;

      try {
        const response = await fetch(`/api/context/memory/${encodeURIComponent(name)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: textarea.value })
        });

        if (response.ok) {
          showToast(`Memory file "${name}.md" saved`);
        } else {
          showToast('Failed to save memory file', 'error');
        }
      } catch (error) {
        showToast('Failed to save memory file', 'error');
      }
    }

    // ─────────────────────────────────────────────────────────────
    // WebSocket
    // ─────────────────────────────────────────────────────────────

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      try {
        ws = new WebSocket(`${protocol}//${window.location.host}`);
        ws.onopen = () => setConnectionStatus(true);
        ws.onclose = () => {
          setConnectionStatus(false);
          setTimeout(connectWebSocket, 5000);
        };
        ws.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            if (msg.type === 'command' && activeTab === 'live') {
              fetchLiveData();
            }
            if (msg.type === 'model:pull:complete') {
              showToast(`Model pull complete: ${msg.name}`);
              if (activeTab === 'models') {
                fetchInstalledModels();
                fetchRunningModels();
              }
              const bar = document.getElementById('pullProgressBar');
              const text = document.getElementById('pullStatusText');
              if (bar) bar.style.width = '100%';
              if (text) text.textContent = `Pull complete: ${msg.name}`;
            }
            if (msg.type === 'model:pull:error') {
              showToast(`Model pull failed: ${msg.name}`, 'error');
              const bar = document.getElementById('pullProgressBar');
              const text = document.getElementById('pullStatusText');
              if (bar) bar.style.width = '0%';
              if (text) text.textContent = `Pull failed: ${msg.name}`;
            }
            if (msg.type === 'adapter:activated') {
              showToast(`Adapter activated: ${msg.name}`);
              if (activeTab === 'models') {
                fetchAdapters();
                fetchInstalledModels();
              }
            }
            if (msg.type === 'context:updated') {
              if (activeTab === 'context') {
                fetchContextMemory();
                fetchContextIndex();
              }
            }
          } catch (err) {}
        };
      } catch (err) {
        setConnectionStatus(false);
        setTimeout(connectWebSocket, 5000);
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Background Polling
    // ─────────────────────────────────────────────────────────────

    function startBackgroundPolling() {
      backgroundPollingInterval = setInterval(() => {
        // Refresh data periodically even on non-active tabs
        if (activeTab !== 'live') {
          fetchStats();
        }
      }, 30000);
    }

    async function fetchStats() {
      try {
        const response = await fetch('/api/stats');
        const stats = await response.json();

        // Update security badge
        const badge = document.getElementById('securityBadge');
        if (stats.pendingBlocks > 0) {
          badge.textContent = stats.pendingBlocks;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error('Failed to fetch stats:', error);
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Visibility API - pause polling when tab not visible
    // ─────────────────────────────────────────────────────────────

    // ─────────────────────────────────────────────────────────────
    // Achievements Tab Functions
    // ─────────────────────────────────────────────────────────────

    async function fetchAchievements() {
      try {
        const res = await fetch('/api/achievements');
        const data = await res.json();
        renderPlayerCard(data.xp, data.stats, data.badges);
        renderAchievementStats(data.stats);
        renderBadges(data.badges);
      } catch (error) {
        console.error('Failed to fetch achievements:', error);
      }
    }

    function generateCallsign(stats) {
      if (!stats || stats.totalCommands === 0) return 'The Newcomer';
      const ratio = stats.totalBlocked / Math.max(1, stats.totalCommands);
      if (ratio > 0.15) return 'The Gatekeeper';
      if (stats.lateNightCount > 500) return 'Night Owl Supreme';
      if (stats.lateNightCount > 100) return 'The Night Owl';
      if (stats.peakHourCount > 150) return 'Speed Demon';
      if (stats.uniqueAgents >= 4) return 'The Polyglot';
      if (stats.uniqueAgents >= 2) return 'The Diplomat';
      if (stats.cleanestStreak > 1000) return 'Clean Machine';
      if (stats.cleanestStreak > 200) return 'Mr. Clean';
      if (stats.uniqueRepos >= 10) return 'The Empire Builder';
      if (stats.uniqueCommands > 200) return 'The Explorer';
      if (stats.totalCommands > 10000) return 'The Veteran';
      if (stats.totalCommands > 1000) return 'The Regular';
      if (stats.totalSessions > 50) return 'Session Warrior';
      return 'Command Runner';
    }

    function achFormatNumber(n) {
      if (n === null || n === undefined) return '0';
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }

    function achFormatDuration(minutes) {
      if (!minutes || minutes <= 0) return '0m';
      const d = Math.floor(minutes / 1440);
      const h = Math.floor((minutes % 1440) / 60);
      const m = Math.floor(minutes % 60);
      const parts = [];
      if (d > 0) parts.push(d + 'd');
      if (h > 0) parts.push(h + 'h');
      if (m > 0 || parts.length === 0) parts.push(m + 'm');
      return parts.join(' ');
    }

    const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    function renderPlayerCard(xp, stats, badges) {
      // Username from OS: use a generic since we're in the browser
      const username = stats.favoriteAgent || 'Operator';
      document.getElementById('achUsername').textContent = username;
      document.getElementById('achCallsign').textContent = generateCallsign(stats);

      // Top badges: pick unlocked badges sorted by tier desc, show up to 5
      const topBadgesEl = document.getElementById('achTopBadges');
      if (badges && badges.length > 0) {
        const unlocked = badges.filter(b => b.tier > 0).sort((a, b) => b.tier - a.tier || b.progress - a.progress);
        const top = unlocked.slice(0, 5);
        topBadgesEl.innerHTML = top.map(b =>
          `<span class="player-top-badge ptb-${b.tier}">${b.icon} ${escapeHtml(b.name)}</span>`
        ).join('');
      } else {
        topBadgesEl.innerHTML = '';
      }

      // Meta row
      const metaEl = document.getElementById('achMeta');
      const memberStr = stats.memberSince ? 'Since ' + new Date(stats.memberSince).toLocaleDateString() : '';
      metaEl.innerHTML = [
        memberStr,
        stats.totalSessions + ' sessions',
        achFormatNumber(stats.totalCommands) + ' commands'
      ].filter(Boolean).join(' &bull; ');

      // Rank badge
      const rankBadge = document.getElementById('achRankBadge');
      rankBadge.textContent = xp.rank;
      rankBadge.className = 'rank-badge rank-' + xp.rank.toLowerCase();

      // XP bar
      document.getElementById('achXpCurrent').textContent = achFormatNumber(xp.totalXP) + ' XP';
      document.getElementById('achXpNext').textContent = xp.rank === 'Obsidian' ? 'MAX' : achFormatNumber(xp.nextRankXP) + ' XP';
      document.getElementById('achXpFill').style.width = (xp.progress * 100).toFixed(1) + '%';
    }

    function renderAchievementStats(stats) {
      const container = document.getElementById('achStatsContainer');
      const totalPct = (n) => stats.totalCommands > 0 ? ((n / stats.totalCommands) * 100).toFixed(1) + '%' : '0%';

      function category(title, extraClass, content) {
        return `<div class="ach-category ${extraClass}">
          <div class="ach-category-header">${title}</div>
          <div class="ach-category-body"><div class="ach-stats-grid">${content}</div></div>
        </div>`;
      }

      // Core Totals (6 items)
      let core = '';
      core += statCard('\u2694\ufe0f', achFormatNumber(stats.totalCommands), 'Commands Executed', '');
      core += statCard('\ud83d\udee1\ufe0f', achFormatNumber(stats.totalBlocked), 'Threats Blocked', '');
      core += statCard('\ud83d\udcbb', achFormatNumber(stats.totalSessions), 'Sessions', '');
      core += statCard('\u23f1\ufe0f', achFormatDuration(stats.totalWatchTimeMinutes), 'Time Under Watch', '');
      core += statCard('\ud83d\udcc2', String(stats.uniqueRepos), 'Repos Protected', '');
      core += statCard('\ud83d\udd24', achFormatNumber(stats.totalCharacters), 'Characters', '');

      // Agent Breakdown
      let agents_html = '';
      const agents = Object.entries(stats.agentBreakdown || {});
      if (agents.length === 0) {
        agents_html += statCard('\ud83e\udd16', '0', 'No Agents Yet', '');
      } else {
        const maxCount = Math.max(...agents.map(([, c]) => c));
        for (const [agent, count] of agents) {
          const isFav = agent === stats.favoriteAgent;
          const barPct = maxCount > 0 ? ((count / maxCount) * 100).toFixed(0) : 0;
          agents_html += `<div class="ach-stat-card">
            <div class="ach-stat-icon">${isFav ? '\ud83d\udc51' : '\ud83e\udd16'}</div>
            <div class="ach-stat-value">${achFormatNumber(count)}</div>
            <div class="ach-stat-label">${escapeHtml(agent)}</div>
            <div class="ach-stat-sub">${totalPct(count)} of total</div>
            <div class="agent-share-bar"><div class="agent-share-fill" style="width:${barPct}%"></div></div>
          </div>`;
        }
        agents_html += statCard('\ud83c\udf0d', stats.uniqueAgents + '/5', 'Agent Diversity', '');
      }

      // Security (4 items)
      let security = '';
      security += statCard('\u26a0\ufe0f', stats.lifetimeAvgRisk !== undefined ? stats.lifetimeAvgRisk.toFixed(1) : '-', 'Lifetime Avg Risk', '');
      security += statCard('\u2728', achFormatNumber(stats.cleanestStreak), 'Cleanest Streak', 'consecutive clean');
      security += statCard('\ud83c\udfb2', stats.highestRiskCommand ? escapeHtml(truncate(stats.highestRiskCommand, 25)) : '-', 'Highest Risk Cmd', 'risk ' + stats.highestRiskScore);
      security += statCard('\ud83d\udee1\ufe0f', achFormatNumber(stats.totalBlocked), 'Total Blocked', '');

      // Behavioral (8 items)
      let behavioral = '';
      behavioral += statCard('\ud83d\udd01', stats.mostUsedCommand ? escapeHtml(truncate(stats.mostUsedCommand, 25)) : '-', 'Most-Used Command', stats.mostUsedCommandCount + ' times');
      behavioral += statCard('\ud83e\udded', achFormatNumber(stats.uniqueCommands), 'Unique Commands', '');
      behavioral += statCard('\ud83d\udcdd', achFormatNumber(stats.longestCommandLength), 'Longest Command', 'characters');
      behavioral += statCard('\u23f0', stats.peakHour !== null ? stats.peakHour + ':00' : '-', 'Peak Hour', stats.peakHourCount + ' commands');
      behavioral += statCard('\ud83d\udcc5', stats.peakDay !== null ? DAY_NAMES[stats.peakDay] : '-', 'Peak Day', '');
      behavioral += statCard('\ud83d\udd25', stats.busiestDay || '-', 'Busiest Day Ever', stats.busiestDayCount + ' commands');
      behavioral += statCard('\ud83d\udcca', String(stats.avgCommandsPerSession), 'Avg Cmds/Session', '');
      behavioral += statCard('\u23f3', achFormatDuration(stats.longestSessionMinutes), 'Longest Session', '');
      behavioral += statCard('\ud83c\udf19', achFormatNumber(stats.lateNightCount), 'Late Night Cmds', 'midnight\u20135 AM');

      container.innerHTML =
        category('Core Totals', '', core) +
        category('Agents', '', agents_html) +
        category('Security', '', security) +
        category('Behavioral', '', behavioral);
    }

    function statCard(icon, value, label, sub) {
      return `<div class="ach-stat-card">
        <div class="ach-stat-icon">${icon}</div>
        <div class="ach-stat-value">${value}</div>
        <div class="ach-stat-label">${label}</div>
        ${sub ? `<div class="ach-stat-sub">${sub}</div>` : ''}
      </div>`;
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.slice(0, len) + '\u2026' : str;
    }

    function renderBadges(badges) {
      const wall = document.getElementById('achBadgeWall');
      if (!badges || badges.length === 0) {
        wall.innerHTML = '<div class="empty-state">No badges yet. Start running commands!</div>';
        return;
      }

      wall.innerHTML = badges.map(badge => {
        const tierDots = Array.from({ length: 5 }, (_, i) => {
          const tierLevel = i + 1;
          const filled = tierLevel <= badge.tier;
          return `<div class="tier-dot tier-${tierLevel} ${filled ? 'filled' : ''}"></div>`;
        }).join('');

        const progressPct = (badge.progress * 100).toFixed(0);
        const progressText = badge.maxed
          ? 'MAX'
          : achFormatNumber(badge.value) + ' / ' + achFormatNumber(badge.nextThreshold);

        return `<div class="badge-card tier-${badge.tier}">
          <div class="badge-header">
            <div class="badge-icon">${badge.icon}</div>
            <div>
              <div class="badge-name">${escapeHtml(badge.name)}</div>
              <div class="badge-desc">${escapeHtml(badge.description)}</div>
            </div>
          </div>
          <div class="badge-tier-dots">${tierDots}</div>
          <div class="badge-progress-bar"><div class="badge-progress-fill" style="width:${progressPct}%"></div></div>
          <div class="badge-progress-text">${progressText}</div>
        </div>`;
      }).join('');
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopLivePolling();
        stopSecurityPolling();
      } else {
        if (activeTab === 'live') startLivePolling();
        if (activeTab === 'security') startSecurityPolling();
      }
    });

    // ─────────────────────────────────────────────────────────────
    // Init
    // ─────────────────────────────────────────────────────────────

    document.addEventListener('DOMContentLoaded', () => {
      restoreCachedFeed();
      loadConfig();
      connectWebSocket();
      startLivePolling();
      startBackgroundPolling();
    });
  </script>
</body>
</html>
